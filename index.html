<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>WEJUMAN ‚Äî A living map of real and verifiable initiatives</title>

<!-- Google Search Console (optional) -->
<!-- If you already verified, you can keep it or remove it -->
<meta name="google-site-verification" content="PASTE_YOUR_TOKEN_HERE" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
:root{
--bg:#f4f5f7;
--panel:#ffffff;
--text:#111;
--muted:#666;
--border:#e6e6e6;
--shadow:0 12px 40px rgba(0,0,0,0.12);
--radius:18px;

--btn:#111;
--btnText:#fff;
}

html, body { height:100%; margin:0; background:var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
#map { height:100vh; width:100vw; }

/* Top panel */
.panel{
position:fixed;
top: calc(16px + env(safe-area-inset-top));
left:16px;
right:16px;
z-index:9999;
background:var(--panel);
border:1px solid var(--border);
border-radius:var(--radius);
box-shadow:var(--shadow);
overflow:hidden;
}

.panel-inner{
display:grid;
grid-template-columns: 1fr auto;
gap:12px;
padding:14px 14px 12px 14px;
align-items:start;
}

.brand{
font-weight:800;
letter-spacing:0.24em;
font-size:14px;
color:var(--text);
margin-bottom:10px;
}

.searchRow{
display:flex;
align-items:center;
gap:10px;
background:#fff;
border:1px solid var(--border);
border-radius:999px;
padding:10px 12px;
}
.searchIcon{ font-size:16px; opacity:0.65; }
#searchInput{
border:0;
outline:0;
width:100%;
font-size:16px;
background:transparent;
}
.pinBtn{
border:0;
background:#f2f2f2;
border:1px solid var(--border);
border-radius:999px;
width:44px;
height:36px;
cursor:pointer;
font-size:16px;
}

.desc{
margin-top:10px;
color:var(--muted);
line-height:1.35;
font-size:15px;
max-width: 720px;
}

.right{
display:flex;
align-items:flex-start;
justify-content:flex-end;
padding-top: 28px; /* align visually with search */
}
.count{
color:var(--muted);
font-size:14px;
white-space:nowrap;
}

/* CTA block */
.cta{
padding: 0 14px 14px 14px;
color:var(--muted);
border-top:1px solid var(--border);
}
.cta p{
margin:12px 0 10px 0;
font-size:15px;
line-height:1.35;
}
.cta button{
appearance:none;
border:0;
background:var(--btn);
color:var(--btnText);
padding:12px 18px;
border-radius:14px;
font-weight:700;
cursor:pointer;
}

/* Results dropdown */
.results{
position:fixed;
top: calc(16px + env(safe-area-inset-top) + 96px);
left:16px;
right:16px;
z-index:9998;
background:#fff;
border:1px solid var(--border);
border-radius:16px;
box-shadow:var(--shadow);
overflow:hidden;
display:none;
max-height: 40vh;
}
.resultsList{
max-height:40vh;
overflow:auto;
}
.item{
padding:12px 14px;
border-top:1px solid #f0f0f0;
cursor:pointer;
}
.item:first-child{ border-top:0; }
.item strong{ display:block; color:#111; font-size:15px; }
.item span{ display:block; margin-top:4px; color:#666; font-size:13px; }

/* Mobile: make panel less invasive */
@media (max-width: 520px){
.desc{ font-size:14px; }
.cta p{ font-size:14px; }
.right{ padding-top: 18px; }
.results{ top: calc(16px + env(safe-area-inset-top) + 92px); }
}
</style>
</head>

<body>
<div id="map"></div>

<!-- TOP PANEL -->
<div class="panel" role="region" aria-label="Wejuman panel">
<div class="panel-inner">
<div>
<div class="brand">WEJUMAN</div>

<div class="searchRow">
<div class="searchIcon">üîé</div>
<input id="searchInput" type="text" placeholder="Search initiative or place (e.g. Emergency, Nairobi)" />
<button id="locateBtn" class="pinBtn" title="Go to my location">üìç</button>
</div>

<div class="desc">
A living map of real and verifiable initiatives around the world.
Search for an organization (marker) or a city/place.
</div>
</div>

<div class="right">
<div id="count" class="count">Loading‚Ä¶</div>
</div>
</div>

<div class="cta">
<p>Wejuman exists to make real human actions visible. If you‚Äôre active in the world and want to be on the map, contact us.</p>
<button id="contactBtn">Contact us</button>
</div>
</div>

<!-- Results -->
<div id="results" class="results">
<div id="resultsList" class="resultsList"></div>
</div>

<script>
// ========= CONFIG =========
// Where the "Contact us" button goes:
// - mailto:...
// - a Google Form link
// - a /contact.html page
const CONTACT_URL = "mailto:info@wejuman.org?subject=Wejuman%20‚Äî%20Request%20to%20be%20on%20the%20map";

// Data file
const POINTS_URL = "points.json";

// ========= MAP INIT =========
const map = L.map("map", { zoomControl: true }).setView([20, 0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
attribution: "¬© OpenStreetMap contributors"
}).addTo(map);

// ========= CLUSTER =========
const cluster = L.markerClusterGroup({
showCoverageOnHover: false,
spiderfyOnMaxZoom: true,
disableClusteringAtZoom: 12,
maxClusterRadius: 55
});
map.addLayer(cluster);

// ========= UI HOOKS =========
const searchInput = document.getElementById("searchInput");
const locateBtn = document.getElementById("locateBtn");
const contactBtn = document.getElementById("contactBtn");
const countEl = document.getElementById("count");
const resultsEl = document.getElementById("results");
const resultsListEl = document.getElementById("resultsList");

contactBtn.addEventListener("click", () => {
window.location.href = CONTACT_URL;
});

locateBtn.addEventListener("click", () => {
if (!navigator.geolocation) return alert("Geolocation not supported.");
navigator.geolocation.getCurrentPosition(
(pos) => {
const lat = pos.coords.latitude;
const lng = pos.coords.longitude;
map.setView([lat, lng], 10);
},
() => alert("I can't access your location (permission denied).")
);
});

// ========= DATA =========
let items = []; // raw points
let markers = []; // { marker, data }

function escapeHtml(str){
return String(str ?? "")
.replaceAll("&", "&amp;")
.replaceAll("<", "&lt;")
.replaceAll(">", "&gt;")
.replaceAll('"', "&quot;")
.replaceAll("'", "&#39;");
}

function popupHtml(p){
const name = escapeHtml(p.name);
const city = escapeHtml(p.city || "");
const country = escapeHtml(p.country || "");
const category = escapeHtml(p.category || "");
const loc = [city, country].filter(Boolean).join(", ");

return `
<div style="min-width:220px">
<strong style="font-size:15px">${name}</strong>
<div style="margin-top:6px;color:#666;font-size:13px">${loc}</div>
<div style="margin-top:6px;color:#111;font-size:13px">${category}</div>
</div>
`;
}

function showResults(list){
resultsListEl.innerHTML = "";
list.slice(0, 40).forEach(p => {
const name = escapeHtml(p.name);
const city = escapeHtml(p.city || "");
const country = escapeHtml(p.country || "");
const category = escapeHtml(p.category || "");
const loc = [city, country].filter(Boolean).join(", ");

const div = document.createElement("div");
div.className = "item";
div.innerHTML = `<strong>${name}</strong><span>${loc}${loc && category ? " ‚Ä¢ " : ""}${category}</span>`;
div.onclick = () => {
resultsEl.style.display = "none";
map.setView([p.lat, p.lng], Math.max(map.getZoom(), 8));
// open popup for its marker
const it = markers.find(x => x.data === p);
if (it) it.marker.openPopup();
};
resultsListEl.appendChild(div);
});

resultsEl.style.display = list.length ? "block" : "none";
}

function hideResults(){
resultsEl.style.display = "none";
}

document.addEventListener("click", (e) => {
// close results if click outside panel/results
const panel = document.querySelector(".panel");
if (!panel.contains(e.target) && !resultsEl.contains(e.target)) hideResults();
});

function filter(q){
q = (q || "").trim().toLowerCase();
if (!q) return [];
return items.filter(p => {
const hay = [
p.name, p.city, p.country, p.category
].filter(Boolean).join(" ").toLowerCase();
return hay.includes(q);
});
}

searchInput.addEventListener("input", () => {
const q = searchInput.value;
const res = filter(q);
showResults(res);
});

// ========= LOAD =========
async function loadPoints(){
try{
const res = await fetch(POINTS_URL, { cache: "no-store" });
if (!res.ok) throw new Error("HTTP " + res.status);
const data = await res.json();

if (!Array.isArray(data)) throw new Error("points.json must be an array []");

// basic validation + keep only valid coords
items = data
.filter(p => p && typeof p.lat === "number" && typeof p.lng === "number")
.map(p => ({
name: p.name || "Unknown",
category: p.category || "",
level: (typeof p.level === "number") ? p.level : 0,
city: p.city || "",
country: p.country || "",
lat: p.lat,
lng: p.lng
}));

// clear cluster + markers
cluster.clearLayers();
markers = [];

items.forEach(p => {
const m = L.marker([p.lat, p.lng]).bindPopup(popupHtml(p));
cluster.addLayer(m);
markers.push({ marker: m, data: p });
});

countEl.textContent = `${items.length} initiatives`;
}catch(err){
console.error(err);
countEl.textContent = "Error";
alert("Error: I can't load points.json. Check that it exists in the repo and is valid JSON.");
}
}

loadPoints();
</script>
</body>
</html>
