<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Wejuman</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html, body { height: 100%; margin: 0; }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#000; }
#map { height: 100%; width: 100%; }

/* Minimal top label */
.topbar{
position:absolute; top:12px; left:12px; z-index:999;
display:flex; gap:10px; align-items:center;
padding:8px 10px; border-radius:14px;
background: rgba(0,0,0,0.55);
backdrop-filter: blur(10px);
color:#fff; user-select:none; pointer-events:none;
}
.topbar .brand{ letter-spacing:.22em; font-weight:700; font-size:12px; }
.topbar .count{ opacity:.9; font-size:12px; }

/* Bottom search bar */
.bottom-bar{
position:absolute;
left:50%;
bottom:14px;
transform:translateX(-50%);
width:min(760px, calc(100% - 24px));
display:flex;
gap:10px;
padding:10px 12px;
border-radius:999px;
background: rgba(0,0,0,0.72);
backdrop-filter: blur(12px);
z-index:999;
box-sizing:border-box;
}
.bottom-bar input{
flex:1; border:none; outline:none;
background:transparent; color:#fff;
font-size:16px;
}
.bottom-bar input::placeholder{ color: rgba(255,255,255,0.65); }
.bottom-bar button{
border:none;
background: rgba(255,255,255,0.12);
color:#fff;
border-radius:999px;
padding:8px 12px;
font-size:16px;
}

/* Toast hint */
.toast{
position:absolute;
left:50%;
bottom:74px;
transform:translateX(-50%);
width:min(760px, calc(100% - 24px));
padding:10px 12px;
border-radius:14px;
background: rgba(0,0,0,0.72);
backdrop-filter: blur(12px);
color:#fff;
z-index:999;
box-sizing:border-box;
display:none;
font-size:14px;
line-height:1.25;
}
.toast.show{ display:block; }

/* Optional pulse ring */
.pulse-ring{
pointer-events:none;
border-radius:50%;
border:2px solid rgba(0,120,255,0.55);
background: rgba(0,120,255,0.10);
}

/* Controls subtle */
.leaflet-control-zoom a{
background: rgba(0,0,0,0.55) !important;
color:#fff !important;
border:none !important;
backdrop-filter: blur(10px);
}
.leaflet-bar{ box-shadow:none !important; }
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
<div class="brand">WEJUMAN</div>
<div class="count" id="globalCount">loading‚Ä¶</div>
</div>

<div class="toast" id="toast"></div>

<div class="bottom-bar">
<input id="searchInput" type="text" placeholder="Search a place (e.g., Torino)" autocomplete="off" />
<button id="searchBtn" aria-label="Search">üîç</button>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/**********************
* CONFIG
**********************/
// ‚úÖ Cambia solo questa riga se repo/user sono diversi
const POINTS_URL = "https://raw.githubusercontent.com/mysalvavhd-ai/wejuman-map/main/points.json";

const SMART_HINT_MIN_ZOOM = 9;
const SMART_HINT_DEBOUNCE_MS = 650;
const TOAST_MS = 2600;
const NOMINATIM_REVERSE_ZOOM = 10;
const SHOW_PULSE_RING = true;

/**********************
* MAP INIT
**********************/
const map = L.map("map", { zoomControl: true, worldCopyJump: true })
.setView([20, 0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19,
attribution: "&copy; OpenStreetMap"
}).addTo(map);

/**********************
* CLUSTER LAYER
**********************/
const clusters = L.markerClusterGroup({
showCoverageOnHover: false,
spiderfyOnMaxZoom: true,
disableClusteringAtZoom: 12
});
map.addLayer(clusters);

/**********************
* UI HELPERS
**********************/
const toastEl = document.getElementById("toast");
function showToast(msg){
toastEl.textContent = msg;
toastEl.classList.add("show");
clearTimeout(showToast._t);
showToast._t = setTimeout(() => toastEl.classList.remove("show"), TOAST_MS);
}

/**********************
* DATA
**********************/
let actions = [];

function getLat(a){
return a.lat ?? a.latitude ?? a.LAT ?? a.Lat;
}
function getLon(a){
return a.lon ?? a.lng ?? a.longitude ?? a.LON ?? a.Lon;
}

async function loadPoints(){
const res = await fetch(POINTS_URL, { cache: "no-store" });
if (!res.ok) throw new Error("Cannot load points.json (check POINTS_URL)");
actions = await res.json();

document.getElementById("globalCount").textContent = `${actions.length} initiatives`;

clusters.clearLayers();

let placed = 0;
for (const a of actions){
const lat = getLat(a);
const lon = getLon(a);

if (typeof lat !== "number" || typeof lon !== "number") continue;

clusters.addLayer(L.marker([lat, lon], { title: a.name || "" }));
placed++;
}

// Se hai 112 record ma 0 marker: mancano coordinate numeriche
if (placed === 0 && actions.length > 0){
showToast("Loaded points, but no coordinates found (lat/lon missing).");
}
}

/**********************
* COUNT IN VIEWPORT
**********************/
function countActionsInBounds(bounds){
let c = 0;
for (const a of actions){
const lat = getLat(a), lon = getLon(a);
if (typeof lat !== "number" || typeof lon !== "number") continue;
if (bounds.contains([lat, lon])) c++;
}
return c;
}

/**********************
* OPTIONAL PULSE RING
**********************/
let pulseCircle = null;

function updatePulseRing(){
if (!SHOW_PULSE_RING) return;

const z = map.getZoom();
if (z < SMART_HINT_MIN_ZOOM){
if (pulseCircle){ map.removeLayer(pulseCircle); pulseCircle = null; }
return;
}

const center = map.getCenter();
const meters = Math.max(1200, 22000 / Math.pow(1.35, (z - SMART_HINT_MIN_ZOOM)));

if (!pulseCircle){
pulseCircle = L.circle([center.lat, center.lng], {
radius: meters,
className: "pulse-ring",
interactive: false
}).addTo(map);
} else {
pulseCircle.setLatLng([center.lat, center.lng]);
pulseCircle.setRadius(meters);
}
}

/**********************
* REVERSE GEOCODE (Nominatim)
**********************/
async function reverseGeocode(lat, lon){
const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=${NOMINATIM_REVERSE_ZOOM}&lat=${lat}&lon=${lon}`;
const res = await fetch(url, { headers: { "Accept-Language": "it" } });
const data = await res.json();
if (!data || !data.address) return null;
const a = data.address;
return a.city || a.town || a.village || a.county || a.state || null;
}

/**********************
* SMART HINT (on navigation)
**********************/
let smartHintTimer = null;
let lastKey = "";

function boundsKey(){
const b = map.getBounds();
const c = b.getCenter();
return `${c.lat.toFixed(3)}:${c.lng.toFixed(3)}:${map.getZoom()}`;
}

async function smartHint(){
if (!actions.length) return;

updatePulseRing();

const z = map.getZoom();
if (z < SMART_HINT_MIN_ZOOM) return;

const key = boundsKey();
if (key === lastKey) return;
lastKey = key;

const bounds = map.getBounds();
const count = countActionsInBounds(bounds);
if (count <= 0) return;

const center = map.getCenter();

try{
const place = await reverseGeocode(center.lat, center.lng);
showToast(place ? `${place} ‚Äî ${count} initiatives in this area`
: `${count} initiatives in this area`);
} catch(e){
showToast(`${count} initiatives in this area`);
}
}

function scheduleSmartHint(){
clearTimeout(smartHintTimer);
smartHintTimer = setTimeout(smartHint, SMART_HINT_DEBOUNCE_MS);
}

map.on("moveend", scheduleSmartHint);
map.on("zoomend", scheduleSmartHint);

/**********************
* SEARCH (place -> center + hint)
**********************/
async function geocodePlace(query){
const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
const res = await fetch(url, { headers: { "Accept-Language": "it" } });
const data = await res.json();
if (!data?.length) return null;
return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
}

async function runSearch(){
const q = document.getElementById("searchInput").value.trim();
if (!q) return;

const place = await geocodePlace(q);
if (!place){
showToast("No results for that place.");
return;
}

map.setView([place.lat, place.lon], Math.max(map.getZoom(), SMART_HINT_MIN_ZOOM));

setTimeout(() => scheduleSmartHint(), 450);
}

document.getElementById("searchBtn").addEventListener("click", runSearch);
document.getElementById("searchInput").addEventListener("keydown", (e) => {
if (e.key === "Enter") runSearch();
});

/**********************
* BOOT
**********************/
loadPoints()
.then(() => scheduleSmartHint())
.catch(err => {
console.error(err);
document.getElementById("globalCount").textContent = "error";
showToast("Error loading points.json (check POINTS_URL)");
});
</script>
</body>
</html>
