<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wejuman — A living map of human action</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body, #map { height: 100%; margin: 0; }
:root{
--bar: rgba(255,255,255,.92);
--text:#111;
--muted:#5a5a5a;
--shadow: 0 10px 30px rgba(0,0,0,.18);
--radius: 16px;
}

.bar{
position: fixed;
left: 50%;
transform: translateX(-50%);
width: min(720px, calc(100% - 24px));
background: var(--bar);
color: var(--text);
border-radius: var(--radius);
box-shadow: var(--shadow);
z-index: 1000;
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
}

#topBar{
top: 12px;
padding: 12px 14px;
display: grid;
grid-template-columns: 44px 1fr auto;
gap: 10px;
align-items: center;
}
#btnMenu{
width:44px;height:44px;border-radius:12px;border:none;
background: rgba(0,0,0,.06);
font-size: 20px; cursor:pointer;
}
#title{ font-weight: 800; letter-spacing:.2px; }
#subtitle{ font-size: 12px; color: var(--muted); margin-top:2px; }

#chip{
padding: 10px 12px;
border-radius: 999px;
background: rgba(0,0,0,.06);
font-size: 13px;
color: var(--muted);
white-space: nowrap;
}

#bottomBar{
bottom: 12px;
padding: 12px 14px;
}
#nearTitle{ font-weight: 800; margin-bottom: 6px; }
.nearItem{
font-size: 14px;
color: var(--text);
padding: 6px 0;
border-top: 1px solid rgba(0,0,0,.06);
cursor: pointer;
}
.nearItem:first-of-type{ border-top:none; }
.nearMeta{ color: var(--muted); font-size: 13px; }

/* Modal menu */
#overlay{
position: fixed; inset: 0;
background: rgba(0,0,0,.22);
display:none;
z-index: 2000;
}
#panel{
width: min(760px, calc(100% - 24px));
margin: 90px auto;
background: rgba(255,255,255,.94);
border-radius: 18px;
box-shadow: var(--shadow);
padding: 16px;
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
color: var(--text);
}
#panel h3{ margin:0 0 6px 0; }
#panel p{ margin:0 0 10px 0; color: var(--muted); }

.catWrap{ display:flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
.cat{
padding: 10px 14px;
border-radius: 999px;
background: rgba(0,0,0,.06);
cursor: pointer;
user-select:none;
font-weight: 700;
font-size: 14px;
}
.cat.active{ background:#2ecbd6; color:#fff; }

.row{
display:flex; gap: 10px; align-items:center; margin-top: 12px;
padding-top: 10px; border-top: 1px solid rgba(0,0,0,.08);
color: var(--muted);
font-size: 14px;
}
input[type="checkbox"]{ width:18px; height:18px; }

.closeBtn{
margin-top: 12px;
border:none;
background: rgba(0,0,0,.06);
padding: 10px 14px;
border-radius: 12px;
cursor:pointer;
font-weight: 700;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="topBar" class="bar">
<button id="btnMenu" title="Categorie">☰</button>

<div>
<div id="title">Wejuman</div>
<div id="subtitle">A living map of verified human action</div>
</div>

<div id="chip">Dati: points.json</div>
</div>

<div id="bottomBar" class="bar">
<div id="nearTitle">Nearby</div>
<div id="nearList">
<div class="nearMeta">Move or zoom the map to discover nearby initiatives.</div>
</div>
</div>

<div id="overlay">
<div id="panel">
<h3>Categorie</h3>
<p><b>Il filtro non giudica</b>: evidenzia ciò che cerchi, senza “cancellare” il resto.</p>
<div class="catWrap" id="cats"></div>

<div class="row">
<input id="onlyHighlighted" type="checkbox">
<label for="onlyHighlighted">Mostra solo evidenziati</label>
</div>

<div class="row" id="stats">—</div>

<button class="closeBtn" id="btnClose">Chiudi</button>
</div>
</div>

<script>
// ===== CONFIG =====
const POINTS_URL = "points.json";
const CATEGORIES = [
"Ambiente","Cibo","Acqua","Salute","Educazione",
"Bambini","Donne","Diritti umani","Emergenze",
"Comunità","Rifugiati","Generale"
];

// ===== STATE =====
let points = [];
let selected = "Tutte"; // categoria evidenziata
let onlyHighlighted = false; // nasconde gli altri se true

let markers = []; // {p, m}
let placeCache = new Map(); // key= "lat,lon" approx -> text
let reverseTimer = null;
let lastReverseAtZoomBand = ""; // evita spam
let abortCtl = null;

// ===== MAP =====
const map = L.map("map", { zoomControl: false }).setView([20,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19
}).addTo(map);

// ===== UI =====
const elSub = document.getElementById("subtitle");
const elNear = document.getElementById("nearList");
const elStats = document.getElementById("stats");

document.getElementById("btnMenu").onclick = openMenu;
document.getElementById("btnClose").onclick = closeMenu;
document.getElementById("overlay").onclick = (e)=>{ if(e.target.id==="overlay") closeMenu(); };

const chkOnly = document.getElementById("onlyHighlighted");
chkOnly.onchange = ()=>{
onlyHighlighted = chkOnly.checked;
applyHighlight();
updateNearby();
updateStats();
};

// ===== LOAD =====
fetch(POINTS_URL)
.then(r=>r.json())
.then(d=>{
points = (Array.isArray(d)? d : []).map(p => ({
...p,
category: (p.category && p.category.trim()) ? p.category.trim() : "Generale"
}));
buildMarkers();
buildMenu();
applyHighlight();
updateNearby();
updateStats();
updatePerception(); // set subtitle initial
})
.catch(()=>{
elNear.innerHTML = `<div class="nearMeta">Errore: non riesco a caricare points.json</div>`;
});

function buildMarkers(){
markers.forEach(x=> map.removeLayer(x.m));
markers = [];

points.forEach(p=>{
const m = L.marker([p.lat, p.lon]).addTo(map);
m.on("click", ()=>{
const url = p.website ? p.website : `https://www.google.com/search?q=${encodeURIComponent(p.name)}`;
window.open(url, "_blank");
});
markers.push({p, m});
});
}

// ===== PRO: 3 states (Lontano / Medio / Vicino) =====
function zoomBand(z){
if(z < 4) return "lontano";
if(z < 10) return "medio";
return "vicino";
}

function updatePerception(){
const z = map.getZoom();
const band = zoomBand(z);
if(band==="lontano") elSub.textContent = "Coscienza globale";
if(band==="medio") elSub.textContent = "Scoperta";
if(band==="vicino") elSub.textContent = "Presenza umana";
}

// ===== HIGHLIGHT (non giudica) =====
function isHighlighted(p){
return (selected==="Tutte") ? true : (p.category === selected);
}

function applyHighlight(){
let visibleCount = 0;
let highlightedCount = 0;

markers.forEach(({p,m})=>{
const hi = isHighlighted(p);
if(hi) highlightedCount++;

if(onlyHighlighted && !hi){
if(map.hasLayer(m)) map.removeLayer(m);
}else{
if(!map.hasLayer(m)) m.addTo(map);
const iconEl = m.getElement && m.getElement();
if(iconEl){
iconEl.style.opacity = hi ? "1" : "0.28";
iconEl.style.filter = hi ? "none" : "grayscale(1)";
}
visibleCount++;
}
});

updateStats(visibleCount, highlightedCount);
}

function updateStats(visibleCount, highlightedCount){
if(visibleCount == null){
// ricalcolo veloce
visibleCount = markers.filter(({p,m})=> map.hasLayer(m)).length;
highlightedCount = points.filter(isHighlighted).length;
}
elStats.textContent = `Punti: ${points.length} · Visibili: ${visibleCount} · Evidenziati: ${highlightedCount}`;
}

// ===== NEARBY (qui intorno) =====
function updateNearby(){
const center = map.getCenter();
const z = map.getZoom();
const band = zoomBand(z);

// raggio suggerimenti: lontano = grande, vicino = piccolo
const maxKm =
band==="lontano" ? 4000 :
band==="medio" ? 1200 :
80;

const MAX_ITEMS = 20;

// prima calcolo tutti ordinati per distanza
const ordered = points
.map(p => ({ p, km: map.distance(center, [p.lat, p.lon]) / 1000 }))
.filter(x => !onlyHighlighted || isHighlighted(x.p))
.sort((a, b) => a.km - b.km);

// poi applico raggio "soft", ma se sono pochi riempio comunque
const within = ordered.filter(x => x.km <= maxKm);

const list = (within.length >= Math.min(5, MAX_ITEMS))
? within.slice(0, MAX_ITEMS)
: ordered.slice(0, MAX_ITEMS);


if(list.length === 0){
elNear.innerHTML = `<div class="nearMeta">Nessun punto nel raggio (${maxKm} km). Zooma/sposta.</div>`;
return;
}

elNear.innerHTML = list.map(x=>{
const p = x.p;
const km = x.km.toFixed(1);
const cat = p.category || "Generale";
return `
<div class="nearItem" onclick="openLink('${escapeHtml(p.name)}','${escapeHtml(p.website||"")}')">
${escapeHtml(p.name)}
<div class="nearMeta">${escapeHtml(cat)} · ${km} km</div>
</div>
`;
}).join("");
}

window.openLink = function(name, website){
const url = website ? website : `https://www.google.com/search?q=${encodeURIComponent(name)}`;
window.open(url, "_blank");
};

function escapeHtml(s){
return (s||"").replace(/[&<>"']/g, m=>({
"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));
}

// ===== REVERSE GEOCODE (stabile, no network crash) =====
function shouldReverseNow(){
const band = zoomBand(map.getZoom());
// Niente reverse in "lontano"
if(band === "lontano") return false;
return true;
}

function reverseGeocode(){
if(!shouldReverseNow()) return;

const c = map.getCenter();
// chiave cache arrotondata
const key = `${c.lat.toFixed(3)},${c.lng.toFixed(3)}`;
if(placeCache.has(key)){
elSub.textContent = placeCache.get(key);
return;
}

// evita sovrapposizioni
if(abortCtl) abortCtl.abort();
abortCtl = new AbortController();

fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${c.lat}&lon=${c.lng}`, {
signal: abortCtl.signal,
headers: { "Accept": "application/json" }
})
.then(r=>r.json())
.then(d=>{
const a = d && d.address ? d.address : {};
const place = a.city || a.town || a.village || a.county || a.state || a.country || "—";
placeCache.set(key, place);
elSub.textContent = place; // qui appare “Roma”
})
.catch(()=>{
// fallback: NON rompe nulla
// non cambiamo testo se fallisce
});
}

// ===== MENU =====
function buildMenu(){
const cats = document.getElementById("cats");
cats.innerHTML = "";

const all = ["Tutte", ...CATEGORIES];
all.forEach(cat=>{
const b = document.createElement("div");
b.className = "cat" + (cat===selected ? " active" : "");
b.textContent = cat;
b.onclick = ()=>{
selected = cat;
// aggiorna stato pulsanti
Array.from(cats.children).forEach(x=> x.classList.remove("active"));
b.classList.add("active");

applyHighlight();
updateNearby();
updateStats();
};
cats.appendChild(b);
});
}

function openMenu(){
document.getElementById("overlay").style.display = "block";
chkOnly.checked = onlyHighlighted;
updateStats();
}
function closeMenu(){
document.getElementById("overlay").style.display = "none";
}

// ===== EVENTS =====
map.on("zoomend", ()=>{
updatePerception();
updateNearby();
applyHighlight();

// reverse solo se “medio/vicino” e con debounce
clearTimeout(reverseTimer);
reverseTimer = setTimeout(reverseGeocode, 550);
});

map.on("moveend", ()=>{
updateNearby();

// reverse SOLO quando cambia banda o quando ti fermi
clearTimeout(reverseTimer);
reverseTimer = setTimeout(reverseGeocode, 650);
});

</script>
</body>
</html>
