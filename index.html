<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Wejuman</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
--panel-bg: rgba(255,255,255,0.98);
--border: rgba(0,0,0,0.10);
--shadow: 0 10px 30px rgba(0,0,0,0.14);
--text: #111;
--muted: #5b5b5b;
--accent: #1a73e8; /* vibe Google */
--radius: 14px;
}

html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
#map { height: 100%; width: 100%; }

/* Top bar (Google Maps-ish) */
#topbar{
position: fixed;
top: 14px;
left: 50%;
transform: translateX(-50%);
z-index: 9999;
width: min(860px, calc(100vw - 28px));
background: var(--panel-bg);
border: 1px solid var(--border);
border-radius: var(--radius);
box-shadow: var(--shadow);
backdrop-filter: blur(6px);
overflow: hidden;
}

#topbar-inner{
display:flex;
align-items:center;
gap:10px;
padding: 10px;
}

#brand{
display:flex;
align-items:baseline;
gap:10px;
padding-left: 6px;
white-space: nowrap;
}
#brand strong{
font-size: 14px;
letter-spacing: 0.16em;
font-weight: 800;
}
#brand span{
font-size: 12px;
color: var(--muted);
}

#searchWrap{
position: relative;
flex: 1;
min-width: 220px;
}

#search{
width: 100%;
border: 1px solid rgba(0,0,0,0.14);
border-radius: 12px;
padding: 10px 12px 10px 36px;
font-size: 14px;
outline: none;
background: #fff;
}
#search:focus{
border-color: rgba(26,115,232,0.55);
box-shadow: 0 0 0 3px rgba(26,115,232,0.12);
}

.icon{
position:absolute;
left: 11px;
top: 50%;
transform: translateY(-50%);
color: rgba(0,0,0,0.55);
font-size: 14px;
user-select: none;
}

#actions{
display:flex;
gap:8px;
padding-right: 6px;
}
.btn{
border: 1px solid rgba(0,0,0,0.14);
background: #fff;
border-radius: 12px;
padding: 9px 10px;
font-size: 13px;
cursor: pointer;
user-select: none;
}
.btn:hover{ border-color: rgba(0,0,0,0.25); }
.btn.primary{
border-color: rgba(26,115,232,0.35);
}

/* Suggestions dropdown */
#suggestions{
display:none;
position:absolute;
top: 44px;
left: 0;
right: 0;
background: #fff;
border: 1px solid rgba(0,0,0,0.12);
border-radius: 12px;
box-shadow: 0 14px 35px rgba(0,0,0,0.18);
overflow: hidden;
z-index: 10000;
}
.sugg{
padding: 10px 12px;
font-size: 14px;
border-bottom: 1px solid rgba(0,0,0,0.06);
cursor: pointer;
display:flex;
justify-content: space-between;
gap:12px;
}
.sugg:last-child{ border-bottom:none; }
.sugg:hover{ background: rgba(26,115,232,0.06); }
.sugg small{ color: var(--muted); }

/* Title/description panel */
#about{
padding: 0 10px 10px 10px;
border-top: 1px solid rgba(0,0,0,0.06);
display:flex;
justify-content: space-between;
gap: 10px;
align-items: flex-start;
}
#about p{
margin: 8px 6px 0 6px;
font-size: 12.5px;
color: var(--muted);
line-height: 1.25;
}
#status{
margin: 8px 6px 0 0;
font-size: 12px;
color: var(--muted);
white-space: nowrap;
}

/* Leaflet popup tweak */
.leaflet-popup-content { margin: 10px 12px; }
.leaflet-popup-content b { font-size: 14px; }
.leaflet-popup-content small { color: #666; }

/* Mobile spacing */
@media (max-width: 520px){
#brand span{ display:none; }
.btn span{ display:none; }
.btn{ padding: 9px 10px; }
}
</style>
</head>

<body>
<div id="topbar">
<div id="topbar-inner">
<div id="brand">
<strong>WEJUMAN</strong>
<span>verified human action map</span>
</div>

<div id="searchWrap">
<div class="icon">üîé</div>
<input id="search" type="search" placeholder="Cerca iniziativa o luogo (es. Emergency, Sydney)‚Ä¶" autocomplete="off" />
<div id="suggestions"></div>
</div>

<div id="actions">
<button class="btn primary" id="locBtn" title="Vai alla mia posizione">üìç <span>Posizione</span></button>
<button class="btn" id="resetBtn" title="Vista mondo">üåç <span>Mondo</span></button>
<button class="btn" id="clearBtn" title="Svuota ricerca">‚úñÔ∏é <span>Clear</span></button>
</div>
</div>

<div id="about">
<p>
Una mappa viva di iniziative reali e verificabili nel mondo. Cerca un‚Äôorganizzazione (marker) oppure una citt√†/luogo.
</p>
<div id="status">Loading‚Ä¶</div>
</div>
</div>

<div id="map"></div>

<script>
// --- MAP BASE ---
const WORLD_VIEW = { center: [20, 0], zoom: 2 };

const map = L.map('map', { zoomControl: true }).setView(WORLD_VIEW.center, WORLD_VIEW.zoom);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --- UI refs ---
const searchEl = document.getElementById('search');
const suggEl = document.getElementById('suggestions');
const statusEl = document.getElementById('status');
const locBtn = document.getElementById('locBtn');
const resetBtn = document.getElementById('resetBtn');
const clearBtn = document.getElementById('clearBtn');

// --- Data structures ---
const markers = []; // { marker, data, key, label }
const byKey = new Map(); // exact key -> marker

function norm(s){
return (s || '').toString().trim().toLowerCase();
}

function safe(v){
return (v === undefined || v === null) ? '' : String(v);
}

function getName(p){
return p.name || p.title || p.organization || p.org || '';
}

function getLabel(p){
const name = getName(p) || 'Untitled';
const city = p.city ? ` ‚Ä¢ ${p.city}` : '';
const country = p.country ? ` ‚Ä¢ ${p.country}` : '';
return `${name}${city}${country}`;
}

function popupHtml(p){
const name = getName(p) || "Untitled";
const city = p.city ? `<br><small>${safe(p.city)}</small>` : '';
const country = p.country ? `<br><small>${safe(p.country)}</small>` : '';
const category = p.category ? `<br><small>${safe(p.category)}</small>` : '';
const level = (p.level !== undefined && p.level !== null) ? `<br><small>Level: ${safe(p.level)}</small>` : '';
const url = p.url ? `<br><small><a href="${p.url}" target="_blank" rel="noopener">Website</a></small>` : '';
const desc = p.description ? `<br><small>${safe(p.description)}</small>` : '';
return `<b>${name}</b>${city}${country}${category}${level}${url}${desc}`;
}

function flyToMarker(m){
const ll = m.getLatLng();
map.flyTo(ll, 12, { duration: 0.85 });
setTimeout(() => m.openPopup(), 650);
}

// --- Suggestions ---
function hideSuggestions(){
suggEl.style.display = 'none';
suggEl.innerHTML = '';
}

function showSuggestions(items){
if (!items.length){
hideSuggestions();
return;
}
suggEl.innerHTML = items.map(it => `
<div class="sugg" data-type="${it.type}" data-key="${it.key || ''}" data-q="${encodeURIComponent(it.q || '')}">
<div>${it.label}</div>
<small>${it.type === 'initiative' ? 'initiative' : 'place'}</small>
</div>
`).join('');
suggEl.style.display = 'block';
}

suggEl.addEventListener('click', async (e) => {
const row = e.target.closest('.sugg');
if (!row) return;

const type = row.getAttribute('data-type');
const key = row.getAttribute('data-key');
const q = decodeURIComponent(row.getAttribute('data-q') || '');

hideSuggestions();

if (type === 'initiative' && key){
const m = byKey.get(key);
if (m) flyToMarker(m);
} else if (type === 'place' && q){
const loc = await geocode(q);
if (loc) map.flyTo([loc.lat, loc.lon], 12, { duration: 0.85 });
}
});

// --- Geocoder (Nominatim) ---
async function geocode(q){
// Nominatim usage: add a small delay? For single searches it's ok.
const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
try{
const res = await fetch(url, { headers: { "Accept": "application/json" } });
const data = await res.json();
if (!data || !data[0]) return null;
return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
}catch(err){
return null;
}
}

// --- Load points.json ---
async function loadPoints(){
try{
const res = await fetch('points.json', { cache: 'no-store' });
const points = await res.json();

let count = 0;

points.forEach(p => {
if (p.lat === undefined || p.lng === undefined) return;

const m = L.marker([p.lat, p.lng]).addTo(map);
m.bindPopup(popupHtml(p));

const key = norm(getName(p));
const label = getLabel(p);

markers.push({ marker: m, data: p, key, label });
if (key && !byKey.has(key)) byKey.set(key, m);

count++;
});

statusEl.textContent = `${count} points`;
}catch(err){
statusEl.textContent = `0 points (points.json missing?)`;
console.warn('points.json not loaded:', err);
}
}

// --- Search behavior (Google-ish) ---
function buildMatches(q){
const qn = norm(q);
if (!qn) return [];

// Initiative matches (top 6)
const hits = markers
.filter(x => x.key && (x.key.includes(qn) || x.label.toLowerCase().includes(qn)))
.slice(0, 6)
.map(x => ({ type:'initiative', key: x.key, label: x.label }));

// Add "search place" option
hits.push({ type:'place', q: q, label: `Search place: ‚Äú${q}‚Äù` });

return hits;
}

let typingTimer = null;

searchEl.addEventListener('input', () => {
clearTimeout(typingTimer);
const q = searchEl.value.trim();
if (!q){
hideSuggestions();
return;
}
typingTimer = setTimeout(() => {
showSuggestions(buildMatches(q));
}, 120);
});

searchEl.addEventListener('keydown', async (e) => {
if (e.key === 'Escape'){
hideSuggestions();
searchEl.blur();
return;
}
if (e.key !== 'Enter') return;

const q = searchEl.value.trim();
if (!q) return;
hideSuggestions();

const qn = norm(q);

// Exact initiative
const exact = byKey.get(qn);
if (exact){
flyToMarker(exact);
return;
}

// First partial initiative
const first = markers.find(x => x.key && x.key.includes(qn));
if (first){
flyToMarker(first.marker);
return;
}

// Fallback to place
const loc = await geocode(q);
if (loc){
map.flyTo([loc.lat, loc.lon], 12, { duration: 0.85 });
} else {
alert("Non trovato. Prova un altro nome o una citt√†.");
}
});

// Close suggestions when clicking outside
document.addEventListener('click', (e) => {
if (!e.target.closest('#searchWrap')) hideSuggestions();
});

// --- Buttons ---
clearBtn.addEventListener('click', () => {
searchEl.value = '';
hideSuggestions();
searchEl.focus();
});

resetBtn.addEventListener('click', () => {
map.flyTo(WORLD_VIEW.center, WORLD_VIEW.zoom, { duration: 0.85 });
});

locBtn.addEventListener('click', () => {
if (!navigator.geolocation){
alert("Geolocalizzazione non disponibile su questo dispositivo/browser.");
return;
}
statusEl.textContent = 'Locating‚Ä¶';
navigator.geolocation.getCurrentPosition(
(pos) => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
map.flyTo([lat, lon], 12, { duration: 0.85 });
statusEl.textContent = `${markers.length} points`;
},
() => {
statusEl.textContent = `${markers.length} points`;
alert("Permesso posizione negato o non disponibile.");
},
{ enableHighAccuracy: true, timeout: 8000 }
);
});

// Start
loadPoints();
</script>
</body>
</html>
