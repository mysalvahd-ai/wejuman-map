<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wejuman</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height: 100%; margin: 0; background:#000; }
#map { height: 100%; width: 100%; }

.topbar{
position:absolute; top:12px; left:12px; z-index:1000;
padding:10px 12px; border-radius:14px;
background: rgba(0,0,0,0.62);
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
color:#fff;
user-select:none;
max-width: calc(100% - 24px);
}
.brand{ letter-spacing:.26em; font-weight:700; font-size:12px; }
.tagline{ margin-top:4px; opacity:.72; font-size:12px; }

/* ✅ WHITE TRANSLUCENT PANEL */
.panel{
position:absolute;
left:50%;
bottom:14px;
transform:translateX(-50%);
width:min(900px, calc(100% - 24px));
z-index:1000;

padding:12px 14px;
border-radius:18px;

background: rgba(255,255,255,0.78);
backdrop-filter: blur(18px);
-webkit-backdrop-filter: blur(18px);

color:#000;
box-sizing:border-box;

display:none;
max-height: 52vh;
overflow:auto;

box-shadow: 0 8px 30px rgba(0,0,0,0.12);
transition: transform 180ms ease, opacity 180ms ease;
}
.panel.show{ display:block; }

/* ✅ “LOWER WHILE MOVING” */
.panel.lowered{
transform: translateX(-50%) translateY(55%);
opacity: 0.55;
}

.place{ font-weight:650; font-size:16px; }
.meta{ font-size:13px; margin-top:2px; color: rgba(0,0,0,0.55); }

.section{ margin-top:10px; }
.sectionTitle{
font-size:12px; letter-spacing:.18em;
text-transform:uppercase;
margin-bottom:8px;
color: rgba(0,0,0,0.50);
}

.item{
font-size:13px; line-height:1.25;
padding:9px 10px;
border-radius:12px;
background: rgba(0,0,0,0.05);
border: 1px solid rgba(0,0,0,0.06);
margin-bottom:8px;
}
.item .n{ font-weight:650; }
.item .t{ opacity:.75; margin-left:6px; }

.aiLine{
font-size:13px; line-height:1.3;
padding:9px 10px;
border-radius:12px;
background: rgba(0,0,0,0.04);
border: 1px solid rgba(0,0,0,0.06);
margin-bottom:8px;
color: rgba(0,0,0,0.82);
}

.btnRow{
display:flex; gap:10px; flex-wrap:wrap;
margin-top:10px;
}
.btn{
display:inline-flex; align-items:center; gap:8px;
padding:10px 12px;
border-radius:999px;
background: rgba(0,0,0,0.06);
color:#000;
text-decoration:none;
font-size:13px;
border:1px solid rgba(0,0,0,0.08);
}
.btn:hover{ background: rgba(0,0,0,0.08); }

.smallNote{
font-size:12px;
margin-top:10px;
color: rgba(0,0,0,0.45);
}

.leaflet-control-zoom a{
background: rgba(255,255,255,0.70) !important;
color:#000 !important;
border:none !important;
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
}
.leaflet-bar{ box-shadow:none !important; }
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
<div class="brand">WEJUMAN</div>
<div class="tagline">A live map of the world that keeps human action visible.</div>
</div>

<div class="panel" id="panel">
<div class="place" id="place">This area</div>
<div class="meta" id="meta">—</div>

<div class="section" id="mappedSection" style="display:none;">
<div class="sectionTitle">Mapped initiatives</div>
<div id="mappedList"></div>
</div>

<div class="section" id="aiSection" style="display:none;">
<div class="sectionTitle">Suggestions</div>
<div id="aiLines"></div>
<div class="btnRow" id="aiButtons"></div>
<div class="smallNote">Visibility does not imply completeness.</div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/**********************
* CONFIG
**********************/
const POINTS_URL = "./points.json"; // same folder
const MIN_ZOOM_SHOW_PANEL = 4;
const UPDATE_DEBOUNCE_MS = 650;

function nominatimZoomForMapZoom(z){
if (z >= 13) return 14;
if (z >= 10) return 12;
if (z >= 7) return 10;
return 6;
}

const AI_LINES = [
"Human action is likely present in this area.",
"AI suggests recurring forms of human action related to community care, food support, education access, health assistance and emergency response.",
"You can explore independently outside the map."
];

/**********************
* STATE
**********************/
let mappedPoints = [];
let markerLayer = null;

/**********************
* Helpers
**********************/
function escapeHtml(s){
return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function openSearch(query){
const q = encodeURIComponent(query);
window.open(`https://duckduckgo.com/?q=${q}`, "_blank", "noopener,noreferrer");
}

function pointsInBounds(bounds){
const arr = [];
for (const p of mappedPoints){
if (!Number.isFinite(p.lat) || !Number.isFinite(p.lon)) continue;
if (bounds.contains([p.lat, p.lon])) arr.push(p);
}
return arr;
}

async function reverseGeocode(lat, lon, mapZoom){
const z = nominatimZoomForMapZoom(mapZoom);
const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=${z}&lat=${lat}&lon=${lon}`;

const res = await fetch(url, { headers: { "Accept-Language":"en" } });
if (!res.ok) return null;

const data = await res.json();
const a = data?.address || {};

const city = a.city || a.town || a.village || a.municipality || a.hamlet || a.locality || null;
const region = a.state || a.region || a.county || a.state_district || null;
const country = a.country || null;

const place = city || region || country || "This area";
return { place, city, region, country };
}

function focusLabel(geo){
return geo?.city || geo?.region || geo?.country || geo?.place || "this area";
}

/**********************
* MAP
**********************/
const map = L.map("map", { zoomControl:true, worldCopyJump:true }).setView([20,0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom:19,
attribution:"&copy; OpenStreetMap"
}).addTo(map);

markerLayer = L.layerGroup().addTo(map);

function renderMarkers(){
markerLayer.clearLayers();
for (const p of mappedPoints){
if (!Number.isFinite(p.lat) || !Number.isFinite(p.lon)) continue;
L.circleMarker([p.lat, p.lon], {
radius: 6,
weight: 2,
opacity: 0.9,
fillOpacity: 0.14
}).addTo(markerLayer);
}
}

async function loadPoints(){
const res = await fetch(POINTS_URL, { cache:"no-store" });
if (!res.ok) throw new Error(`Cannot fetch points.json: ${res.status}`);

const data = await res.json();
if (!Array.isArray(data)) throw new Error("points.json must be an array");

mappedPoints = data
.filter(p => p && typeof p === "object")
.map(p => ({
name: String(p.name || "").trim(),
tagline: String(p.tagline || "").trim(),
lat: Number(p.lat),
lon: Number(p.lon)
}))
.filter(p => p.name && Number.isFinite(p.lat) && Number.isFinite(p.lon));

renderMarkers();
}

/**********************
* PANEL UI
**********************/
const panel = document.getElementById("panel");
const placeEl = document.getElementById("place");
const metaEl = document.getElementById("meta");

const mappedSection = document.getElementById("mappedSection");
const mappedList = document.getElementById("mappedList");

const aiSection = document.getElementById("aiSection");
const aiLinesEl = document.getElementById("aiLines");
const aiButtons = document.getElementById("aiButtons");

function renderMapped(list){
mappedList.innerHTML = "";
for (const p of list){
const div = document.createElement("div");
div.className = "item";
div.innerHTML = `<span class="n">${escapeHtml(p.name)}</span><span class="t">${escapeHtml(p.tagline)}</span>`;
mappedList.appendChild(div);
}
}

function renderAi(geo){
aiLinesEl.innerHTML = "";
aiButtons.innerHTML = "";

for (const line of AI_LINES){
const d = document.createElement("div");
d.className = "aiLine";
d.textContent = line;
aiLinesEl.appendChild(d);
}

const focus = focusLabel(geo);

const b1 = document.createElement("a");
b1.className = "btn"; b1.href = "#";
b1.textContent = `Explore initiatives in ${focus}`;
b1.addEventListener("click", (e) => { e.preventDefault(); openSearch(`${focus} community initiatives`); });

const b2 = document.createElement("a");
b2.className = "btn"; b2.href = "#";
b2.textContent = `Explore volunteering in ${focus}`;
b2.addEventListener("click", (e) => { e.preventDefault(); openSearch(`${focus} volunteer opportunities`); });

const b3 = document.createElement("a");
b3.className = "btn"; b3.href = "#";
b3.textContent = `Explore support & aid in ${focus}`;
b3.addEventListener("click", (e) => { e.preventDefault(); openSearch(`${focus} food bank shelter clinic support`); });

aiButtons.appendChild(b1);
aiButtons.appendChild(b2);
aiButtons.appendChild(b3);
}

let timer = null;
async function updatePanel(){
const z = map.getZoom();
if (z < MIN_ZOOM_SHOW_PANEL){
panel.classList.remove("show");
return;
}

const bounds = map.getBounds();
const center = map.getCenter();
const inView = pointsInBounds(bounds);

let geo = { place:"This area", city:null, region:null, country:null };
try{
const r = await reverseGeocode(center.lat, center.lng, z);
if (r) geo = r;
}catch(e){}

placeEl.textContent = geo.place;

if (inView.length){
metaEl.textContent = `${inView.length} initiative${inView.length>1 ? "s" : ""} visible here`;
mappedSection.style.display = "block";
renderMapped(inView);
}else{
metaEl.textContent = "0 mapped initiatives visible here";
mappedSection.style.display = "none";
mappedList.innerHTML = "";
}

aiSection.style.display = "block";
renderAi(geo);

panel.classList.add("show");
}

function scheduleUpdate(){
clearTimeout(timer);
timer = setTimeout(updatePanel, UPDATE_DEBOUNCE_MS);
}

/**********************
* PANEL BEHAVIOR WHILE MOVING
**********************/
map.on("movestart", () => { panel.classList.add("lowered"); });
map.on("zoomstart", () => { panel.classList.add("lowered"); });

map.on("moveend", () => {
panel.classList.remove("lowered");
scheduleUpdate();
});

map.on("zoomend", () => {
panel.classList.remove("lowered");
scheduleUpdate();
});

/**********************
* START
**********************/
(async function init(){
try{
await loadPoints();
}catch(err){
console.error(err);
}
scheduleUpdate();
})();
</script>
</body>
</html>
