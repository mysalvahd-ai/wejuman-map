<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wejuman ‚Äî V0.1</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="./icons/icon-192.png">

<!-- Leaflet -->
<link
rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""
/>
<script
src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""
></script>

<style>
html, body { height: 100%; margin: 0; background: #000; }
#map { height: 100%; width: 100%; }

/* ===== High Readability UI ===== */
:root{
--ui-bg: rgba(255,255,255,0.22); /* brighter */
--ui-bg-strong: rgba(255,255,255,0.30);
--ui-border: rgba(255,255,255,0.32);
--ui-border-strong: rgba(255,255,255,0.45);
--ui-text: #ffffff; /* pure white */
--ui-shadow: 0 10px 40px rgba(0,0,0,0.35);
}

.ui {
position: absolute;
left: 12px;
right: 12px;
bottom: 12px;
z-index: 1000;
display: flex;
gap: 10px;
align-items: center;
justify-content: space-between;
pointer-events: none;
}

.panel {
pointer-events: auto;
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
background: var(--ui-bg);
border: 1px solid var(--ui-border);
border-radius: 16px;
padding: 10px 12px;
color: var(--ui-text);
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
box-shadow: var(--ui-shadow);
}

.brand {
display: flex; align-items: center; gap: 10px;
padding: 10px 14px;
min-width: 170px;
}
.brand .dot {
width: 10px; height: 10px; border-radius: 999px;
background: rgba(255,255,255,0.95);
box-shadow: 0 0 0 3px rgba(0,0,0,0.18);
}
.brand .title { font-weight: 650; letter-spacing: 0.2px; color: #fff; }
.brand .sub { font-size: 12px; color: #fff; opacity: 0.92; margin-top: 2px; }

.lensbar {
display: flex;
gap: 8px;
padding: 10px;
overflow: auto;
scrollbar-width: none;
}
.lensbar::-webkit-scrollbar { display: none; }

.lens {
pointer-events: auto;
user-select: none;
border: 1px solid var(--ui-border);
background: rgba(0,0,0,0.18); /* keep contrast with map */
color: #fff; /* pure white */
padding: 10px 12px;
border-radius: 999px;
font-size: 13px;
font-weight: 600;
display: flex;
align-items: center;
gap: 8px;
cursor: pointer;
white-space: nowrap;
transition: transform 120ms ease, background 120ms ease, border 120ms ease;
}
.lens:active { transform: scale(0.98); }

/* Active: clearly brighter */
.lens.active {
background: var(--ui-bg-strong);
border: 1px solid var(--ui-border-strong);
box-shadow: 0 0 0 2px rgba(0,0,0,0.12) inset;
}

.btn {
pointer-events: auto;
border: 1px solid var(--ui-border);
background: rgba(0,0,0,0.18);
color: #fff; /* pure white */
padding: 10px 12px;
border-radius: 12px;
cursor: pointer;
font-size: 13px;
font-weight: 650;
display: inline-flex;
align-items: center;
gap: 8px;
user-select: none;
}
.btn:active { transform: scale(0.99); }

.status {
position: absolute;
top: 12px;
left: 12px;
z-index: 1000;
pointer-events: none;
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
color: #fff; /* pure white */
font-size: 12px;
font-weight: 650;
background: rgba(0,0,0,0.42);
border: 1px solid rgba(255,255,255,0.22);
border-radius: 999px;
padding: 8px 10px;
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
}

/* Reduce UI while user interacts with map (but keep readability) */
.ui.minimized .panel { padding: 8px 10px; }
.ui.minimized .brand .sub { display: none; }
.ui.minimized .lens { padding: 8px 10px; font-size: 12px; }
.ui.minimized .btn { padding: 8px 10px; font-size: 12px; }

/* Popup style */
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
background: rgba(18,18,18,0.92);
color: rgba(255,255,255,0.96);
border: 1px solid rgba(255,255,255,0.12);
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
}
.leaflet-popup-content {
margin: 10px 12px;
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.p-title { font-weight: 750; margin-bottom: 6px; }
.p-meta { font-size: 12px; opacity: 0.88; line-height: 1.35; }
.p-pill {
display: inline-block;
font-size: 11px;
padding: 4px 8px;
border-radius: 999px;
border: 1px solid rgba(255,255,255,0.18);
background: rgba(255,255,255,0.10);
margin-top: 8px;
}
a { color: #fff; }
</style>
</head>

<body>
<div id="map"></div>

<div class="status" id="status">Wejuman V0.1 ‚Äî ready</div>

<div class="ui" id="ui">
<div class="panel brand">
<div class="dot"></div>
<div>
<div class="title">Wejuman</div>
<div class="sub">An app that is not an app ‚Äî V0.1</div>
</div>
</div>

<div class="panel lensbar" id="lensbar">
<div class="lens active" data-lens="human_actions">ü´∂ Human Actions</div>
<div class="lens" data-lens="homes">üè† Homes</div>
<div class="lens" data-lens="nature">üåø Nature</div>
<div class="lens" data-lens="culture">üèõÔ∏è Culture</div>
<div class="lens" data-lens="mobility">üß≠ Mobility</div>
<div class="lens" data-lens="all">üåç All</div>
</div>

<div class="panel" style="display:flex; gap:8px; align-items:center;">
<div class="btn" id="locate">üìç Locate</div>
<div class="btn" id="refresh">‚Üª Refresh</div>
</div>
</div>

<script>
/** =========================
* Wejuman V0.1 core
* - Human Actions: local JSON (data/human_actions.json)
* - Other lenses: OSM via Overpass
* ========================= */

const statusEl = document.getElementById("status");
const uiEl = document.getElementById("ui");
const lensbar = document.getElementById("lensbar");
const locateBtn = document.getElementById("locate");
const refreshBtn = document.getElementById("refresh");

// Map
const map = L.map("map", {
zoomControl: false,
preferCanvas: true
}).setView([20, 0], 2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19,
attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

L.control.zoom({ position: "topright" }).addTo(map);

// Layers
const layers = {
human_actions: L.layerGroup().addTo(map),
homes: L.layerGroup(),
nature: L.layerGroup(),
culture: L.layerGroup(),
mobility: L.layerGroup()
};

let activeLens = "human_actions";
let humanActionsLoaded = false;
let moveTimer = null;

function setStatus(msg) { statusEl.textContent = msg; }

// White markers (readable)
function makeCircleMarker(latlng) {
return L.circleMarker(latlng, {
radius: 6,
weight: 1.4,
color: "rgba(255,255,255,0.95)",
opacity: 0.98,
fillColor: "rgba(255,255,255,0.60)",
fillOpacity: 0.90
});
}

function popupHTML({ name, metaLines = [], level = null, source_url = null }) {
const meta = metaLines.filter(Boolean).join("<br/>");
const levelPill = (level === null || level === undefined) ? "" : `<div class="p-pill">level ${level}</div>`;
const source = source_url ? `<div class="p-meta" style="margin-top:8px;"><a href="${escapeAttr(source_url)}" target="_blank" rel="noopener">source</a></div>` : "";
return `
<div class="p-title">${escapeHTML(name || "Unknown")}</div>
${meta ? `<div class="p-meta">${meta}</div>` : ""}
${levelPill}
${source}
`;
}

function escapeHTML(str) {
return String(str ?? "").replace(/[&<>"']/g, s => ({
"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
}[s]));
}
function escapeAttr(str) {
return escapeHTML(str).replace(/"/g, "&quot;");
}

/** Lens switching */
function setActiveLens(lens) {
activeLens = lens;

document.querySelectorAll(".lens").forEach(el => {
el.classList.toggle("active", el.dataset.lens === lens);
});

Object.values(layers).forEach(layer => map.removeLayer(layer));

if (lens === "all") {
map.addLayer(layers.human_actions);
map.addLayer(layers.homes);
map.addLayer(layers.nature);
map.addLayer(layers.culture);
map.addLayer(layers.mobility);
} else {
map.addLayer(layers[lens]);
}

if (!humanActionsLoaded) loadHumanActions();

if (lens !== "human_actions") {
refreshOSM();
} else {
setStatus("Human Actions ‚Äî ready");
}
}

/** Human Actions (local JSON) */
async function loadHumanActions() {
try {
setStatus("Loading Human Actions‚Ä¶");
const res = await fetch("./data/human_actions.json", { cache: "no-store" });
if (!res.ok) throw new Error("data/human_actions.json not found");
const data = await res.json();

layers.human_actions.clearLayers();
const points = Array.isArray(data) ? data : (data.points || []);

points.forEach(p => {
const lat = Number(p.lat), lng = Number(p.lng);
if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

const m = makeCircleMarker([lat, lng]);
m.bindPopup(popupHTML({
name: p.name || "Human Action",
metaLines: [
p.city ? `${escapeHTML(p.city)}${p.country ? ", " + escapeHTML(p.country) : ""}` : (p.country ? escapeHTML(p.country) : ""),
p.category ? escapeHTML(p.category) : ""
],
level: (p.level ?? 0),
source_url: p.source_url || null
}));
m.addTo(layers.human_actions);
});

humanActionsLoaded = true;
setStatus(`Human Actions ‚Äî ${points.length} loaded`);
} catch (e) {
humanActionsLoaded = true;
setStatus("Human Actions ‚Äî no local dataset yet");
console.warn(e);
}
}

/** OSM via Overpass */
const OVERPASS = "https://overpass-api.de/api/interpreter";

const OSM_QUERIES = {
homes: [
'nwr["amenity"="shelter"]({{bbox}});',
'nwr["amenity"="social_facility"]({{bbox}});',
'nwr["tourism"="hostel"]({{bbox}});'
],
nature: [
'nwr["natural"="beach"]({{bbox}});',
'nwr["leisure"="park"]({{bbox}});',
'nwr["leisure"="nature_reserve"]({{bbox}});',
'nwr["boundary"="protected_area"]({{bbox}});',
'nwr["highway"="path"]({{bbox}});',
'nwr["route"="hiking"]({{bbox}});'
],
culture: [
'nwr["tourism"="museum"]({{bbox}});',
'nwr["amenity"="library"]({{bbox}});',
'nwr["amenity"="theatre"]({{bbox}});',
'nwr["amenity"="arts_centre"]({{bbox}});',
'nwr["tourism"="attraction"]({{bbox}});',
'nwr["historic"]({{bbox}});'
],
mobility: [
'nwr["public_transport"="station"]({{bbox}});',
'nwr["public_transport"="platform"]({{bbox}});',
'nwr["highway"="bus_stop"]({{bbox}});',
'nwr["railway"="station"]({{bbox}});',
'nwr["highway"="cycleway"]({{bbox}});'
]
};

function bboxString() {
const b = map.getBounds();
return [
b.getSouth().toFixed(6),
b.getWest().toFixed(6),
b.getNorth().toFixed(6),
b.getEast().toFixed(6)
].join(",");
}

function buildOverpassQuery(lens) {
const bbox = bboxString();
const parts = OSM_QUERIES[lens].map(q => q.replace("{{bbox}}", bbox)).join("\n");
return `
[out:json][timeout:25];
(
${parts}
);
out tags center;
`;
}

function pickName(tags) {
if (!tags) return null;
return tags.name || tags["name:en"] || tags.brand || tags.operator || null;
}
function pickPlace(tags) {
if (!tags) return null;
return tags.addr_city || tags["addr:city"] || tags["addr:place"] || null;
}
function lensLabel(lens) {
return ({ homes:"Homes", nature:"Nature", culture:"Culture", mobility:"Mobility" }[lens] || lens);
}

async function fetchOverpass(lens) {
const query = buildOverpassQuery(lens);
const res = await fetch(OVERPASS, {
method: "POST",
headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
body: "data=" + encodeURIComponent(query)
});
if (!res.ok) throw new Error(`Overpass error (${res.status})`);
return await res.json();
}

function addOSMResultsToLayer(lens, osmJson) {
const group = layers[lens];
group.clearLayers();

const els = osmJson.elements || [];
const seen = new Set();

for (const el of els) {
const key = `${el.type}/${el.id}`;
if (seen.has(key)) continue;
seen.add(key);

const lat = el.lat ?? el.center?.lat;
const lon = el.lon ?? el.center?.lon;
if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

const tags = el.tags || {};
const name = pickName(tags) || `${lensLabel(lens)} point`;
const place = pickPlace(tags);

const mainTag = (() => {
const keys = ["amenity","tourism","natural","leisure","public_transport","railway","highway","historic","boundary","route"];
for (const k of keys) if (tags[k]) return `${k}=${tags[k]}`;
return "OSM";
})();

const m = makeCircleMarker([lat, lon]);
m.bindPopup(popupHTML({
name,
metaLines: [
place ? escapeHTML(place) : "",
mainTag ? escapeHTML(mainTag) : "OSM"
]
}));
m.addTo(group);
}
}

async function refreshOSM() {
const lensList = (activeLens === "all")
? ["homes","nature","culture","mobility"]
: (activeLens === "human_actions" ? [] : [activeLens]);

if (!lensList.length) return;

try {
setStatus(`Loading ${lensList.map(lensLabel).join(", ")}‚Ä¶`);
for (const lens of lensList) {
const osm = await fetchOverpass(lens);
addOSMResultsToLayer(lens, osm);
}
setStatus(`Ready ‚Äî ${lensList.map(lensLabel).join(" ‚Ä¢ ")}`);
} catch (e) {
console.warn(e);
setStatus("OSM load failed (Overpass busy). Try refresh.");
}
}

/** minimize UI while moving */
function minimizeUI(on) { uiEl.classList.toggle("minimized", on); }

map.on("movestart", () => minimizeUI(true));
map.on("moveend", () => {
minimizeUI(false);
if (moveTimer) clearTimeout(moveTimer);
moveTimer = setTimeout(() => {
if (activeLens !== "human_actions") refreshOSM();
}, 600);
});

/** UI events */
lensbar.addEventListener("click", (e) => {
const target = e.target.closest(".lens");
if (!target) return;
setActiveLens(target.dataset.lens);
});

locateBtn.addEventListener("click", () => {
if (!navigator.geolocation) return setStatus("Geolocation not available");
setStatus("Locating‚Ä¶");
navigator.geolocation.getCurrentPosition(
(pos) => {
map.setView([pos.coords.latitude, pos.coords.longitude], 13, { animate: true });
setStatus("Located");
},
() => setStatus("Location denied"),
{ enableHighAccuracy: true, timeout: 8000 }
);
});

refreshBtn.addEventListener("click", () => {
if (activeLens === "human_actions") {
humanActionsLoaded = false;
loadHumanActions();
} else {
refreshOSM();
}
});

/** boot */
(async function boot() {
await loadHumanActions();
setActiveLens("human_actions");
})();
</script>

<!-- PWA service worker registration -->
<script>
if ("serviceWorker" in navigator) {
window.addEventListener("load", () => {
navigator.serviceWorker.register("./sw.js").catch(console.warn);
});
}
</script>
</body>
</html>
