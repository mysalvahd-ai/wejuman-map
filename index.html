<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wejuman</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height: 100%; margin: 0; background:#000; }
#map { height: 100%; width: 100%; }

.topbar{
position:absolute; top:12px; left:12px; z-index:1000;
padding:10px 12px; border-radius:14px;
background: rgba(0,0,0,0.62);
backdrop-filter: blur(12px);
color:#fff;
user-select:none;
max-width: calc(100% - 24px);
}
.brand{ letter-spacing:.26em; font-weight:700; font-size:12px; }
.tagline{ margin-top:4px; opacity:.72; font-size:12px; }

.panel{
position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
width:min(900px, calc(100% - 24px));
z-index:1000;
padding:12px 14px; border-radius:18px;
background: rgba(0,0,0,0.70);
backdrop-filter: blur(14px);
color:#fff;
box-sizing:border-box;
display:none;

max-height: 50vh;
overflow:auto;
}
.panel.show{ display:block; }

.place{ font-weight:650; font-size:15px; }
.meta{ opacity:.72; font-size:13px; margin-top:2px; }

.section{ margin-top:10px; }
.sectionTitle{
font-size:12px; letter-spacing:.18em;
text-transform:uppercase; opacity:.7;
margin-bottom:8px;
}

.item{
font-size:13px; line-height:1.25;
padding:8px 10px;
border-radius:12px;
background: rgba(255,255,255,0.06);
margin-bottom:8px;
}
.item .n{ font-weight:650; }
.item .t{ opacity:.75; margin-left:6px; }

.mapped{ background: rgba(255,255,255,0.08); }

.aiLine{
font-size:13px; line-height:1.3;
opacity:.92;
padding:8px 10px;
border-radius:12px;
background: rgba(255,255,255,0.04);
border:1px solid rgba(255,255,255,0.08);
margin-bottom:8px;
}

.btnRow{
display:flex; gap:10px; flex-wrap:wrap;
margin-top:10px;
}
.btn{
display:inline-flex; align-items:center; gap:8px;
padding:9px 12px;
border-radius:999px;
background: rgba(255,255,255,0.10);
color:#fff; text-decoration:none;
font-size:13px;
border:1px solid rgba(255,255,255,0.10);
}
.btn:hover{ background: rgba(255,255,255,0.14); }

.smallNote{
font-size:12px;
opacity:.55;
margin-top:10px;
}

.leaflet-control-zoom a{
background: rgba(0,0,0,0.55) !important;
color:#fff !important;
border:none !important;
backdrop-filter: blur(10px);
}
.leaflet-bar{ box-shadow:none !important; }
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
<div class="brand">WEJUMAN</div>
<div class="tagline">A live map of the world that keeps human action visible.</div>
</div>

<div class="panel" id="panel">
<div class="place" id="place">This area</div>
<div class="meta" id="meta">—</div>

<div class="section" id="mappedSection" style="display:none;">
<div class="sectionTitle">Mapped initiatives</div>
<div id="mappedList"></div>
</div>

<div class="section" id="aiSection" style="display:none;">
<div class="sectionTitle">Suggestions</div>
<div id="aiLines"></div>
<div class="btnRow" id="aiButtons"></div>
<div class="smallNote">Visibility does not imply completeness.</div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/**********************
* YOUR MAPPED / ANCHOR POINTS (Wejuman-curated)
**********************/
const mappedPoints = [
{ name:"Isha Foundation (Sadhguru)", tagline:"Environmental action, education and rural health initiatives.", lat:11.0168, lon:76.9558 },
{ name:"Addi Road Community Organisation", tagline:"Community meals and social support.", lat:-33.9236, lon:151.0940 },
{ name:"EMERGENCY", tagline:"Free healthcare in war zones and underserved areas.", lat:45.4642, lon:9.1900 },
{ name:"Médecins Sans Frontières", tagline:"Medical assistance in conflict and crisis zones.", lat:46.2044, lon:6.1432 }
];

/**********************
* Definitive Wejuman AI voice (short + honest)
**********************/
const AI_LINE_A = "Human action is likely present in this area.";
const AI_LINE_B = "AI suggests recurring forms of human action related to community care, food support, education access, health assistance and emergency response.";
const AI_LINE_C = "You can explore independently outside the map.";

/**********************
* Helpers
**********************/
function escapeHtml(s){
return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function pointsInBounds(bounds){
const arr = [];
for (const p of mappedPoints){
if (typeof p.lat !== "number" || typeof p.lon !== "number") continue;
if (bounds.contains([p.lat, p.lon])) arr.push(p);
}
return arr;
}

function openSearch(query){
const q = encodeURIComponent(query);
window.open(`https://duckduckgo.com/?q=${q}`, "_blank", "noopener,noreferrer");
}

/**********************
* Reverse geocode (worldwide): city / region / country
**********************/
async function reverseGeocode(lat, lon){
const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=10&lat=${lat}&lon=${lon}`;
const res = await fetch(url, { headers:{ "Accept-Language":"en" } });
if (!res.ok) return null;
const data = await res.json();
const a = data?.address || {};

const city = a.city || a.town || a.village || a.municipality || a.hamlet || null;
const region = a.state || a.region || a.county || null;
const country = a.country || null;

const place = city || region || country || "This area";

return { place, city, region, country };
}

function buildFocusLabel(geo){
// Use the most specific label available for searches
// e.g., "Rovigo", else "Veneto", else "Italy"
return geo?.city || geo?.region || geo?.country || geo?.place || "this area";
}

/**********************
* MAP
**********************/
const map = L.map("map", { zoomControl:true, worldCopyJump:true }).setView([20,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom:19, attribution:"&copy; OpenStreetMap"
}).addTo(map);

const markerLayer = L.layerGroup().addTo(map);
for (const p of mappedPoints){
if (typeof p.lat !== "number" || typeof p.lon !== "number") continue;
L.circleMarker([p.lat, p.lon], {
radius: 6,
weight: 2,
opacity: 0.9,
fillOpacity: 0.14
}).addTo(markerLayer);
}

/**********************
* PANEL
**********************/
const panel = document.getElementById("panel");
const placeEl = document.getElementById("place");
const metaEl = document.getElementById("meta");

const mappedSection = document.getElementById("mappedSection");
const mappedList = document.getElementById("mappedList");

const aiSection = document.getElementById("aiSection");
const aiLines = document.getElementById("aiLines");
const aiButtons = document.getElementById("aiButtons");

const MIN_ZOOM_SHOW = 4;
const DEBOUNCE_MS = 650;

function renderMapped(list){
mappedList.innerHTML = "";
for (const p of list){
const div = document.createElement("div");
div.className = "item mapped";
div.innerHTML = `<span class="n">${escapeHtml(p.name)}</span><span class="t">${escapeHtml(p.tagline)}</span>`;
mappedList.appendChild(div);
}
}

function renderAi(geo){
aiLines.innerHTML = "";
aiButtons.innerHTML = "";

const l1 = document.createElement("div");
l1.className = "aiLine";
l1.textContent = AI_LINE_A;
aiLines.appendChild(l1);

const l2 = document.createElement("div");
l2.className = "aiLine";
l2.textContent = AI_LINE_B;
aiLines.appendChild(l2);

const l3 = document.createElement("div");
l3.className = "aiLine";
l3.textContent = AI_LINE_C;
aiLines.appendChild(l3);

const focus = buildFocusLabel(geo);

// 3 doors to the world (auto-city)
const b1 = document.createElement("a");
b1.className = "btn";
b1.href = "#";
b1.textContent = `Explore initiatives in ${focus}`;
b1.addEventListener("click", (e) => {
e.preventDefault();
openSearch(`${focus} community initiatives`);
});

const b2 = document.createElement("a");
b2.className = "btn";
b2.href = "#";
b2.textContent = `Explore volunteering in ${focus}`;
b2.addEventListener("click", (e) => {
e.preventDefault();
openSearch(`${focus} volunteer opportunities`);
});

const b3 = document.createElement("a");
b3.className = "btn";
b3.href = "#";
b3.textContent = `Explore support & aid in ${focus}`;
b3.addEventListener("click", (e) => {
e.preventDefault();
openSearch(`${focus} food bank shelter clinic support`);
});

aiButtons.appendChild(b1);
aiButtons.appendChild(b2);
aiButtons.appendChild(b3);
}

let timer = null;
async function updatePanel(){
const z = map.getZoom();
if (z < MIN_ZOOM_SHOW){
panel.classList.remove("show");
return;
}

const bounds = map.getBounds();
const center = map.getCenter();
const mappedInView = pointsInBounds(bounds);

let geo = { place:"This area", city:null, region:null, country:null };
try{
const r = await reverseGeocode(center.lat, center.lng);
if (r) geo = r;
} catch(e){}

// show in UI
placeEl.textContent = geo.place;

if (mappedInView.length){
metaEl.textContent = `${mappedInView.length} initiative${mappedInView.length>1 ? "s" : ""} visible here`;
mappedSection.style.display = "block";
renderMapped(mappedInView);
} else {
metaEl.textContent = "0 mapped initiatives visible here";
mappedSection.style.display = "none";
mappedList.innerHTML = "";
}

aiSection.style.display = "block";
renderAi(geo);

panel.classList.add("show");
}

function scheduleUpdate(){
clearTimeout(timer);
timer = setTimeout(updatePanel, DEBOUNCE_MS);
}

map.on("moveend", scheduleUpdate);
map.on("zoomend", scheduleUpdate);
scheduleUpdate();
</script>
</body>
</html>
