<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wejuman ‚Äî V0.1</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#f6f7f9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icons/icon-192.png">

<!-- Leaflet -->
<link
rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""
/>
<script
src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""
></script>

<style>
html, body { height: 100%; margin: 0; background: #fff; }
#map { height: 100%; width: 100%; }

:root{
--panel: rgba(255,255,255,0.96);
--panel2: rgba(248,249,251,0.98);
--border: rgba(0,0,0,0.10);
--border2: rgba(0,0,0,0.14);
--text: #111111;
--muted: rgba(17,17,17,0.62);
--muted2: rgba(17,17,17,0.48);
--shadow: 0 10px 28px rgba(0,0,0,0.18);
--radius: 14px;
}

/* Top bar */
.topbar {
position: absolute;
left: 12px;
right: 12px;
top: 12px;
z-index: 1000;
background: var(--panel);
border: 1px solid var(--border);
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 12px 14px;
display: flex;
align-items: center;
justify-content: space-between;
gap: 10px;
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
color: var(--text);
}

.brand {
display: flex;
align-items: center;
gap: 10px;
min-width: 180px;
}
.hamb {
width: 26px; height: 26px; border-radius: 10px;
border: 1px solid var(--border);
display:flex; align-items:center; justify-content:center;
background: var(--panel2);
}
.hamb:before { content:"‚â°"; font-size: 18px; color: var(--text); opacity: 0.9; }

.brandText .name { font-weight: 800; letter-spacing: 0.2px; font-size: 15px; line-height: 1.1; }
.brandText .tag { font-size: 12px; color: var(--muted); font-weight: 650; margin-top: 2px; }

.statusPill {
font-size: 12px;
font-weight: 800;
color: var(--text);
background: var(--panel2);
border: 1px solid var(--border2);
border-radius: 999px;
padding: 8px 10px;
white-space: nowrap;
}

/* Bottom bar */
.bottombar {
position: absolute;
left: 12px;
right: 12px;
bottom: 12px;
z-index: 1000;
display: grid;
grid-template-columns: 1fr auto;
gap: 10px;
align-items: end;
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
color: var(--text);
}

.panel {
background: var(--panel);
border: 1px solid var(--border);
border-radius: var(--radius);
box-shadow: var(--shadow);
}

.lensRow {
display: flex;
gap: 8px;
padding: 10px;
overflow-x: auto;
scrollbar-width: none;
}
.lensRow::-webkit-scrollbar { display: none; }

.lensBtn {
border: 1px solid var(--border2);
background: var(--panel2);
color: var(--text);
border-radius: 999px;
padding: 10px 12px;
font-size: 13px;
font-weight: 900;
display: inline-flex;
align-items: center;
gap: 8px;
white-space: nowrap;
cursor: pointer;
user-select: none;
}
.lensBtn.active {
border-color: rgba(0,0,0,0.22);
background: #ffffff;
}

.rightBtns {
padding: 10px;
display: flex;
gap: 8px;
justify-content: flex-end;
}
.btn {
border: 1px solid var(--border2);
background: var(--panel2);
color: var(--text);
border-radius: 12px;
padding: 10px 12px;
font-size: 13px;
font-weight: 950;
cursor: pointer;
user-select: none;
display: inline-flex;
align-items: center;
gap: 8px;
}

.hint {
padding: 0 12px 10px 12px;
font-size: 12px;
color: var(--muted2);
font-weight: 650;
}

/* Popups */
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
background: #fff;
color: var(--text);
border: 1px solid var(--border);
box-shadow: var(--shadow);
}
.leaflet-popup-content {
margin: 10px 12px;
font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.p-title { font-weight: 950; margin-bottom: 6px; }
.p-meta { font-size: 12px; color: var(--muted); line-height: 1.35; }
.p-pill {
display: inline-block;
font-size: 11px;
padding: 4px 8px;
border-radius: 999px;
border: 1px solid var(--border2);
background: var(--panel2);
margin-top: 8px;
font-weight: 900;
color: var(--text);
}
a { color: var(--text); }

/* Leaflet zoom match style */
.leaflet-control-zoom a {
background: var(--panel);
color: var(--text);
border: 1px solid var(--border);
}

/* iPhone safe area bottom */
@supports (padding: env(safe-area-inset-bottom)) {
.bottombar { bottom: calc(12px + env(safe-area-inset-bottom)); }
}
</style>
</head>

<body>
<div id="map"></div>

<!-- TOP -->
<div class="topbar">
<div class="brand">
<div class="hamb"></div>
<div class="brandText">
<div class="name">Wejuman</div>
<div class="tag">An app that is not an app ‚Äî V0.1</div>
</div>
</div>
<div class="statusPill" id="status">Human ‚Äî ready</div>
</div>

<!-- BOTTOM -->
<div class="bottombar">
<div class="panel">
<div class="lensRow" id="lensbar">
<div class="lensBtn active" data-lens="human">ü´∂ Human</div>
<div class="lensBtn" data-lens="homes">üè† Homes</div>
<div class="lensBtn" data-lens="nature">üåø Nature</div>
<div class="lensBtn" data-lens="culture">üèõÔ∏è Culture</div>
<div class="lensBtn" data-lens="mobility">üß≠ Mobility</div>
<div class="lensBtn" data-lens="all">üåç All</div>
</div>
<div class="hint">Public lenses V0.1 ‚Äî data from OpenStreetMap via Overpass (current map bounds).</div>
</div>

<div class="panel rightBtns">
<div class="btn" id="locate">üìç Locate</div>
<div class="btn" id="refresh">‚Üª Refresh</div>
</div>
</div>

<script>
/** =========================
* Wejuman V0.1 ‚Äî PUBLIC LENSES
* - Human/Homes/Nature/Culture/Mobility: OSM via Overpass (bbox)
* - Marker: visible blue with dark outline
* ========================= */

const statusEl = document.getElementById("status");
const lensbar = document.getElementById("lensbar");
const locateBtn = document.getElementById("locate");
const refreshBtn = document.getElementById("refresh");

function setStatus(msg){ statusEl.textContent = msg; }

// Map
const map = L.map("map", { zoomControl: false, preferCanvas: true }).setView([20, 0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom: 19,
attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);
L.control.zoom({ position: "topright" }).addTo(map);

// Layers (all public now)
const layers = {
human: L.layerGroup().addTo(map),
homes: L.layerGroup(),
nature: L.layerGroup(),
culture: L.layerGroup(),
mobility: L.layerGroup()
};

let activeLens = "human";
let moveTimer = null;

// Marker: BLUE
function makeCircleMarker(latlng) {
return L.circleMarker(latlng, {
radius: 7,
weight: 2,
color: "#0B1220", // dark outline
opacity: 0.95,
fillColor: "#2563EB", // blue fill
fillOpacity: 0.92
});
}

function escapeHTML(str) {
return String(str ?? "").replace(/[&<>"']/g, s => ({
"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[s]));
}
function escapeAttr(str){ return escapeHTML(str).replace(/"/g, "&quot;"); }

function popupHTML({ name, metaLines = [], tag = null, osmLink = null }) {
const meta = metaLines.filter(Boolean).join("<br/>");
const pill = tag ? `<div class="p-pill">${escapeHTML(tag)}</div>` : "";
const link = osmLink
? `<div class="p-meta" style="margin-top:8px;"><a href="${escapeAttr(osmLink)}" target="_blank" rel="noopener">OpenStreetMap</a></div>`
: "";
return `
<div class="p-title">${escapeHTML(name || "Unknown")}</div>
${meta ? `<div class="p-meta">${meta}</div>` : ""}
${pill}
${link}
`;
}

/** Lens switching */
function setActiveLens(lens) {
activeLens = lens;

document.querySelectorAll(".lensBtn").forEach(el => {
el.classList.toggle("active", el.dataset.lens === lens);
});

Object.values(layers).forEach(layer => map.removeLayer(layer));

if (lens === "all") {
map.addLayer(layers.human);
map.addLayer(layers.homes);
map.addLayer(layers.nature);
map.addLayer(layers.culture);
map.addLayer(layers.mobility);
refreshOSM(true);
} else {
map.addLayer(layers[lens]);
refreshOSM(false);
}
}

/** OSM via Overpass */
const OVERPASS = "https://overpass-api.de/api/interpreter";

/**
* Human (public):
* - charity / NGO / community support / food banks / shelters / social facilities
* Note: OSM data quality varies a lot by country. This is "best effort".
*/
const OSM_QUERIES = {
human: human: [
'nwr["amenity"="charity"]({{bbox}});',
'nwr["office"="ngo"]({{bbox}});',
'nwr["amenity"="community_centre"]({{bbox}});',
'nwr["amenity"="food_bank"]({{bbox}});'
],

// Homes A: places to stay + support (clean)
homes: [
'nwr["amenity"="shelter"]({{bbox}});',
'nwr["amenity"="social_facility"]({{bbox}});',
'nwr["tourism"="hostel"]({{bbox}});',
'nwr["tourism"="guest_house"]({{bbox}});',
'nwr["tourism"="hotel"]({{bbox}});'
],

nature: [
'nwr["natural"="beach"]({{bbox}});',
'nwr["leisure"="park"]({{bbox}});',
'nwr["leisure"="nature_reserve"]({{bbox}});',
'nwr["boundary"="protected_area"]({{bbox}});',
'nwr["highway"="path"]({{bbox}});',
'nwr["route"="hiking"]({{bbox}});'
],

culture: [
'nwr["tourism"="museum"]({{bbox}});',
'nwr["amenity"="library"]({{bbox}});',
'nwr["amenity"="theatre"]({{bbox}});',
'nwr["amenity"="arts_centre"]({{bbox}});',
'nwr["tourism"="attraction"]({{bbox}});',
'nwr["historic"]({{bbox}});'
],

mobility: [
'nwr["public_transport"="station"]({{bbox}});',
'nwr["public_transport"="platform"]({{bbox}});',
'nwr["highway"="bus_stop"]({{bbox}});',
'nwr["railway"="station"]({{bbox}});',
'nwr["highway"="cycleway"]({{bbox}});'
]
};

function bboxString(){
const b = map.getBounds();
return [
b.getSouth().toFixed(6),
b.getWest().toFixed(6),
b.getNorth().toFixed(6),
b.getEast().toFixed(6)
].join(",");
}

function buildOverpassQuery(lens){
const bbox = bboxString();
const parts = OSM_QUERIES[lens].map(q => q.replace("{{bbox}}", bbox)).join("\n");
return `
[out:json][timeout:25];
(
${parts}
);
out tags center;
`;
}

function pickName(tags){
if (!tags) return null;
return tags.name || tags["name:en"] || tags.brand || tags.operator || tags.official_name || null;
}
function pickPlace(tags){
if (!tags) return null;
return tags.addr_city || tags["addr:city"] || tags["addr:place"] || null;
}
function lensLabel(lens){
return ({ human:"Human", homes:"Homes", nature:"Nature", culture:"Culture", mobility:"Mobility" }[lens] || lens);
}

function mainTag(tags){
if (!tags) return "OSM";
const keys = ["amenity","office","tourism","natural","leisure","public_transport","railway","highway","historic","boundary","route","social_facility"];
for (const k of keys) if (tags[k]) return `${k}=${tags[k]}`;
return "OSM";
}

function osmUrl(el){
// https://www.openstreetmap.org/node/ID or /way/ID or /relation/ID
return `https://www.openstreetmap.org/${el.type}/${el.id}`;
}

async function fetchOverpass(lens){
const query = buildOverpassQuery(lens);
const res = await fetch(OVERPASS, {
method: "POST",
headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
body: "data=" + encodeURIComponent(query)
});
if (!res.ok) throw new Error(`Overpass error (${res.status})`);
return await res.json();
}

function addOSMResultsToLayer(lens, osmJson){
const group = layers[lens];
group.clearLayers();

const els = osmJson.elements || [];
const seen = new Set();

for (const el of els){
const key = `${el.type}/${el.id}`;
if (seen.has(key)) continue;
seen.add(key);

const lat = el.lat ?? el.center?.lat;
const lon = el.lon ?? el.center?.lon;
if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

const tags = el.tags || {};
const name = pickName(tags) || `${lensLabel(lens)} point`;
const place = pickPlace(tags);
const tag = mainTag(tags);

const m = makeCircleMarker([lat, lon]);
m.bindPopup(popupHTML({
name,
metaLines: [
place ? escapeHTML(place) : "",
tags["addr:street"] ? escapeHTML(tags["addr:street"]) : ""
],
tag,
osmLink: osmUrl(el)
}));
m.addTo(group);
}

return els.length;
}

async function refreshOSM(isAll){
const lensList = isAll
? ["human","homes","nature","culture","mobility"]
: [activeLens];

try{
setStatus(`Loading ${lensList.map(lensLabel).join(", ")}‚Ä¶`);
for (const lens of lensList){
const osm = await fetchOverpass(lens);
addOSMResultsToLayer(lens, osm);
}
setStatus(`Ready ‚Äî ${lensList.map(lensLabel).join(" ‚Ä¢ ")}`);
}catch(e){
console.warn(e);
setStatus("OSM load failed (Overpass busy). Try refresh.");
}
}

/** Auto-refresh after move (debounced) */
map.on("moveend", () => {
if (moveTimer) clearTimeout(moveTimer);
moveTimer = setTimeout(() => {
if (activeLens === "all") refreshOSM(true);
else refreshOSM(false);
}, 650);
});

/** UI events */
lensbar.addEventListener("click", (e) => {
const t = e.target.closest(".lensBtn");
if (!t) return;
setActiveLens(t.dataset.lens);
});

locateBtn.addEventListener("click", () => {
if (!navigator.geolocation) return setStatus("Geolocation not available");
setStatus("Locating‚Ä¶");
navigator.geolocation.getCurrentPosition(
(pos) => {
map.setView([pos.coords.latitude, pos.coords.longitude], 13, { animate: true });
setStatus("Located");
},
() => setStatus("Location denied"),
{ enableHighAccuracy: true, timeout: 8000 }
);
});

refreshBtn.addEventListener("click", () => {
if (activeLens === "all") refreshOSM(true);
else refreshOSM(false);
});

/** boot */
(function boot(){
setActiveLens("human");
})();
</script>

<!-- PWA service worker registration -->
<script>
if ("serviceWorker" in navigator) {
window.addEventListener("load", () => {
navigator.serviceWorker.register("./sw.js").catch(console.warn);
});
}
</script>
</body>
</html>
