<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Wejuman</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html, body { height: 100%; margin: 0; }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#000; }

#map { height: 100%; width: 100%; }

/* Minimal top label (optional) */
.topbar {
position: absolute;
top: 12px;
left: 12px;
z-index: 999;
display: flex;
gap: 10px;
align-items: center;
padding: 8px 10px;
border-radius: 14px;
background: rgba(0,0,0,0.55);
backdrop-filter: blur(10px);
color: #fff;
user-select: none;
pointer-events: none; /* non blocca la mappa */
}
.topbar .brand { letter-spacing: 0.22em; font-weight: 700; font-size: 12px; }
.topbar .count { opacity: 0.9; font-size: 12px; }

/* Bottom search bar */
.bottom-bar{
position: absolute;
left: 50%;
bottom: 14px;
transform: translateX(-50%);
width: min(760px, calc(100% - 24px));
display: flex;
gap: 10px;
padding: 10px 12px;
border-radius: 999px;
background: rgba(0,0,0,0.72);
backdrop-filter: blur(12px);
z-index: 999;
box-sizing: border-box;
}
.bottom-bar input{
flex: 1;
border: none;
outline: none;
background: transparent;
color: #fff;
font-size: 16px;
}
.bottom-bar input::placeholder{ color: rgba(255,255,255,0.65); }
.bottom-bar button{
border: none;
background: rgba(255,255,255,0.12);
color: #fff;
border-radius: 999px;
padding: 8px 12px;
font-size: 16px;
}

/* Toast hint */
.toast{
position: absolute;
left: 50%;
bottom: 74px;
transform: translateX(-50%);
width: min(760px, calc(100% - 24px));
padding: 10px 12px;
border-radius: 14px;
background: rgba(0,0,0,0.72);
backdrop-filter: blur(12px);
color: #fff;
z-index: 999;
box-sizing: border-box;
display: none;
font-size: 14px;
line-height: 1.25;
}
.toast.show { display: block; }

/* Subtle pulse ring (optional) */
.pulse-ring {
pointer-events: none;
border-radius: 50%;
border: 2px solid rgba(255,255,255,0.45);
background: rgba(255,255,255,0.06);
}

/* Leaflet controls subtle */
.leaflet-control-zoom a {
background: rgba(0,0,0,0.55) !important;
color: #fff !important;
border: none !important;
backdrop-filter: blur(10px);
}
.leaflet-bar { box-shadow: none !important; }
</style>
</head>

<body>
<div id="map"></div>

<!-- Minimal brand + global count (no CTA) -->
<div class="topbar" id="topbar">
<div class="brand">WEJUMAN</div>
<div class="count" id="globalCount">‚Äî initiatives</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Bottom search -->
<div class="bottom-bar" id="bottomBar">
<input id="searchInput" type="text" placeholder="Search a place (e.g., Torino)" autocomplete="off" />
<button id="searchBtn" aria-label="Search">üîç</button>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/***************
* CONFIG
***************/
const SMART_HINT_MIN_ZOOM = 9; // da qui in su attiviamo "Torino ‚Äî 12 initiatives..."
const SMART_HINT_DEBOUNCE_MS = 650; // ritardo dopo pan/zoom
const TOAST_MS = 2600; // durata toast
const NOMINATIM_REVERSE_ZOOM = 10; // granularit√† luogo (10 ~ city/town)
const SHOW_PULSE_RING = true; // anello soft sul centro (non modifica i punti)

/***************
* DATA
* Sostituisci questo array con i tuoi punti reali.
* Formato minimo: { name, lat, lon, category }
***************/
const actions = [
{ name: "Sample Torino", lat: 45.0703, lon: 7.6869, category: "Community" },
{ name: "Sample Milano", lat: 45.4642, lon: 9.1900, category: "Health" },
{ name: "Sample Roma", lat: 41.9028, lon: 12.4964, category: "Human Rights" },
{ name: "Sample Nairobi",lat: -1.2864, lon: 36.8172, category: "Environment" },
{ name: "Sample Delhi", lat: 28.6139, lon: 77.2090, category: "Education" },
];

/***************
* MAP INIT
***************/
const map = L.map('map', {
zoomControl: true,
worldCopyJump: true
}).setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
attribution: '&copy; OpenStreetMap'
}).addTo(map);

/***************
* CLUSTERS
***************/
const clusters = L.markerClusterGroup({
showCoverageOnHover: false,
spiderfyOnMaxZoom: true,
disableClusteringAtZoom: 12
});

function makeMarker(a){
const m = L.marker([a.lat, a.lon], { title: a.name });
// Niente popup per ora: coerente "minimal info"
// Se un giorno vuoi: m.bindPopup(`<b>${escapeHtml(a.name)}</b>`);
return m;
}

actions.forEach(a => clusters.addLayer(makeMarker(a)));
map.addLayer(clusters);

document.getElementById("globalCount").textContent = `${actions.length} initiatives`;

/***************
* UI HELPERS
***************/
const toastEl = document.getElementById("toast");
function showToast(msg){
toastEl.textContent = msg;
toastEl.classList.add("show");
clearTimeout(showToast._t);
showToast._t = setTimeout(()=> toastEl.classList.remove("show"), TOAST_MS);
}

function escapeHtml(str){
return String(str).replace(/[&<>"']/g, s => ({
'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
}[s]));
}

/***************
* COUNT IN VIEWPORT
* (vera logica "in this area")
***************/
function countActionsInBounds(bounds){
let c = 0;
for (const a of actions){
if (bounds.contains([a.lat, a.lon])) c++;
}
return c;
}

/***************
* OPTIONAL PULSE RING
***************/
let pulseCircle = null;
function updatePulseRing(){
if (!SHOW_PULSE_RING) return;
const z = map.getZoom();
if (z < SMART_HINT_MIN_ZOOM) {
if (pulseCircle) { map.removeLayer(pulseCircle); pulseCircle = null; }
return;
}

const center = map.getCenter();
// raggio in metri, scalato in modo semplice con zoom
const meters = Math.max(1200, 22000 / Math.pow(1.35, (z - SMART_HINT_MIN_ZOOM)));

if (!pulseCircle) {
pulseCircle = L.circle([center.lat, center.lng], {
radius: meters,
className: 'pulse-ring',
interactive: false
}).addTo(map);
} else {
pulseCircle.setLatLng([center.lat, center.lng]);
pulseCircle.setRadius(meters);
}
}

/***************
* REVERSE GEOCODE (Nominatim)
* Nota: uso leggero, solo su zoom alto e con debounce.
***************/
async function reverseGeocode(lat, lon){
const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=${NOMINATIM_REVERSE_ZOOM}&lat=${lat}&lon=${lon}`;
const res = await fetch(url, { headers: { "Accept-Language": "it" } });
const data = await res.json();
if(!data || !data.address) return null;
const a = data.address;
return a.city || a.town || a.village || a.county || a.state || null;
}

/***************
* SMART HINT ON NAVIGATION
***************/
let smartHintTimer = null;
let lastLabel = "";
let lastBoundsKey = "";

function boundsKey(bounds){
const c = bounds.getCenter();
return `${c.lat.toFixed(3)}:${c.lng.toFixed(3)}:${map.getZoom()}`;
}

async function smartHint(){
const z = map.getZoom();
updatePulseRing();

if (z < SMART_HINT_MIN_ZOOM) return;

const bounds = map.getBounds();
const key = boundsKey(bounds);
if (key === lastBoundsKey) return; // evita ripetizioni
lastBoundsKey = key;

const count = countActionsInBounds(bounds);
if (count <= 0) return;

const center = map.getCenter();
let place = null;

try {
place = await reverseGeocode(center.lat, center.lng);
} catch (e) {
// silenzioso: niente errori a schermo
}

if (place) showToast(`${place} ‚Äî ${count} initiatives in this area`);
else showToast(`${count} initiatives in this area`);
}

function scheduleSmartHint(){
clearTimeout(smartHintTimer);
smartHintTimer = setTimeout(smartHint, SMART_HINT_DEBOUNCE_MS);
}

map.on("moveend", scheduleSmartHint);
map.on("zoomend", scheduleSmartHint);

/***************
* SEARCH (place -> center + count)
***************/
async function geocodePlace(query){
const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`;
const res = await fetch(url, { headers: { "Accept-Language": "it" } });
const data = await res.json();
if(!data?.length) return null;
return {
lat: parseFloat(data[0].lat),
lon: parseFloat(data[0].lon),
label: data[0].display_name
};
}

async function runSearch(){
const input = document.getElementById("searchInput");
const q = input.value.trim();
if (!q) return;

const place = await geocodePlace(q);
if(!place){
showToast("No results for that place.");
return;
}

map.setView([place.lat, place.lon], Math.max(map.getZoom(), SMART_HINT_MIN_ZOOM));

// dopo setView, aspetta che bounds si stabilizzi e poi calcola
setTimeout(async () => {
updatePulseRing();
const b = map.getBounds();
const count = countActionsInBounds(b);
if (count > 0) {
// prova a usare il nome ‚Äúpulito‚Äù dalla reverse (pi√π umano)
let label = null;
try { label = await reverseGeocode(place.lat, place.lon); } catch(e){}
showToast(label ? `${label} ‚Äî ${count} initiatives in this area` : `${count} initiatives in this area`);
} else {
showToast(`No initiatives found in this area.`);
}
}, 450);
}

document.getElementById("searchBtn").addEventListener("click", runSearch);
document.getElementById("searchInput").addEventListener("keydown", (e)=>{
if(e.key === "Enter") runSearch();
});

// Prima hint leggera dopo load
setTimeout(()=> scheduleSmartHint(), 900);
</script>
</body>
</html>
