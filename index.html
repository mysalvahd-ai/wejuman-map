<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wejuman</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height: 100%; margin: 0; background:#000; }
#map { height: 100%; width: 100%; }

.topbar{
position:absolute; top:12px; left:12px; z-index:1000;
padding:10px 12px; border-radius:14px;
background: rgba(0,0,0,0.62);
backdrop-filter: blur(12px);
color:#fff;
user-select:none;
max-width: calc(100% - 24px);
}
.brand{ letter-spacing:.26em; font-weight:700; font-size:12px; }
.tagline{ margin-top:4px; opacity:.72; font-size:12px; }

.panel{
position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
width:min(860px, calc(100% - 24px));
z-index:1000;
padding:12px 14px; border-radius:18px;
background: rgba(0,0,0,0.70);
backdrop-filter: blur(14px);
color:#fff;
box-sizing:border-box;
display:none;
max-height: 46vh;
overflow:auto;
}
.panel.show{ display:block; }

.place{ font-weight:650; font-size:15px; }
.meta{ opacity:.72; font-size:13px; margin-top:2px; }

.section{ margin-top:10px; }
.sectionTitle{
font-size:12px; letter-spacing:.18em;
text-transform:uppercase; opacity:.7;
margin-bottom:8px;
}

.item{
font-size:13px; line-height:1.25;
padding:8px 10px;
border-radius:12px;
background: rgba(255,255,255,0.06);
margin-bottom:8px;
}
.item .n{ font-weight:650; }
.item .t{ opacity:.75; margin-left:6px; }

.mapped{ background: rgba(255,255,255,0.08); }
.suggested{ background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }

.aiLine{
font-size:13px; line-height:1.3;
opacity:.92;
padding:8px 10px;
border-radius:12px;
background: rgba(255,255,255,0.04);
border:1px solid rgba(255,255,255,0.08);
margin-bottom:8px;
}
.smallNote{
font-size:12px;
opacity:.55;
margin-top:6px;
}

.btnRow{
display:flex; gap:10px; flex-wrap:wrap;
margin-top:10px;
}
.btn{
display:inline-flex; align-items:center; gap:8px;
padding:9px 12px;
border-radius:999px;
background: rgba(255,255,255,0.10);
color:#fff; text-decoration:none;
font-size:13px;
border:1px solid rgba(255,255,255,0.10);
}
.btn:hover{ background: rgba(255,255,255,0.14); }

.leaflet-control-zoom a{
background: rgba(0,0,0,0.55) !important;
color:#fff !important;
border:none !important;
backdrop-filter: blur(10px);
}
.leaflet-bar{ box-shadow:none !important; }
</style>
</head>

<body>
<div id="map"></div>

<div class="topbar">
<div class="brand">WEJUMAN</div>
<div class="tagline">A live map of the world that keeps human action visible.</div>
</div>

<div class="panel" id="panel">
<div class="place" id="place">This area</div>
<div class="meta" id="meta">—</div>

<div class="section" id="mappedSection" style="display:none;">
<div class="sectionTitle">Mapped initiatives</div>
<div id="mappedList"></div>
</div>

<div class="section" id="aiSection" style="display:none;">
<div class="sectionTitle">Suggestions</div>
<div id="aiLines"></div>
<div id="aiList"></div>
<div class="smallNote">Visibility does not imply completeness.</div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/**********************
* MAPPED / WEJUMAN POINTS
* (Keep here for stability; later you can move to points.json)
**********************/
const mappedPoints = [
{ name:"Isha Foundation (Sadhguru)", tagline:"Environmental action, education and rural health initiatives.", lat:11.0168, lon:76.9558 },
{ name:"Addi Road Community Organisation", tagline:"Community meals and social support.", lat:-33.9236, lon:151.0940 },
{ name:"EMERGENCY", tagline:"Free healthcare in war zones and underserved areas.", lat:45.4642, lon:9.1900 },
{ name:"Médecins Sans Frontières", tagline:"Medical assistance in conflict and crisis zones.", lat:46.2044, lon:6.1432 }
];

/**********************
* CITY-FIRST AI SUGGESTIONS (not mapped)
* Keys are normalized (lowercase, no accents).
**********************/
const suggestedByCity = {
"sydney": [
{ name: "OzHarvest", hint: "Food rescue & redistribution." },
{ name: "Addi Road Community Organisation", hint: "Community meals & support." }
],
"melbourne": [
{ name: "FareShare", hint: "Meals for people in need." },
{ name: "Asylum Seeker Resource Centre", hint: "Support for refugees and asylum seekers." }
],
"rome": [
{ name: "Caritas Roma", hint: "Local support networks and services." }
],
"milan": [
{ name: "Banco Alimentare", hint: "Food recovery and distribution." }
]
};

const suggestedByRegion = {
"victoria": [
{ name: "FareShare", hint: "Meals for people in need." }
],
"new south wales": [
{ name: "OzHarvest", hint: "Food rescue & redistribution." }
],
"lombardy": [
{ name: "Banco Alimentare", hint: "Food recovery and distribution." }
]
};

const suggestedByCountry = {
"australia": [
{ name: "OzHarvest", hint: "Food rescue & redistribution." }
],
"italy": [
{ name: "Banco Alimentare", hint: "Food recovery and distribution." }
],
"india": [
{ name: "Akshaya Patra", hint: "School meals and nutrition support." }
]
};

const genericAiCategories = [
"community care",
"food support",
"education access",
"health assistance",
"emergency response"
];

/**********************
* Definitive Wejuman AI voice
**********************/
const AI_LINE_A = "Human action is likely present in this area.";
const AI_LINE_B = (cats) => `AI suggests recurring forms of human action in this area, including ${cats}.`;
const AI_LINE_C = "AI has identified recurring references to initiatives related to community kitchens, local health clinics and social support networks.";
const AI_LINE_D = "Some initiatives in this area have been mapped by Wejuman.";
const AI_CLICK_1 = "This entity is suggested by AI based on recurring references in this area.";
const AI_CLICK_2 = "Wejuman does not verify or represent this initiative.";
const AI_CLICK_3 = "You are leaving the map to explore independently.";

/**********************
* Helpers
**********************/
function escapeHtml(s){
return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function normKey(s){
return String(s || "")
.trim()
.toLowerCase()
.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function openExplore(entityName){
const q = encodeURIComponent(entityName);
window.open(`https://duckduckgo.com/?q=${q}`, "_blank", "noopener,noreferrer");
}

function pointsInBounds(bounds){
const arr = [];
for (const p of mappedPoints){
if (typeof p.lat !== "number" || typeof p.lon !== "number") continue;
if (bounds.contains([p.lat, p.lon])) arr.push(p);
}
return arr;
}

/**********************
* Reverse geocode (city/region/country) - worldwide
**********************/
async function reverseGeocode(lat, lon){
const url = `https://nominatim.openstreetmap.org/reverse?format=json&zoom=10&lat=${lat}&lon=${lon}`;
const res = await fetch(url, { headers:{ "Accept-Language":"en" } });
if (!res.ok) return null;
const data = await res.json();
const a = data?.address || {};

const city = a.city || a.town || a.village || a.municipality || a.hamlet || null;
const region = a.state || a.region || a.county || null;
const country = a.country || null;
const place = city || region || country || "This area";

return { place, city, region, country };
}

/**********************
* MAP
**********************/
const map = L.map("map", { zoomControl:true, worldCopyJump:true }).setView([20,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
maxZoom:19, attribution:"&copy; OpenStreetMap"
}).addTo(map);

const markerLayer = L.layerGroup().addTo(map);
for (const p of mappedPoints){
if (typeof p.lat !== "number" || typeof p.lon !== "number") continue;
L.circleMarker([p.lat, p.lon], {
radius: 6,
weight: 2,
opacity: 0.9,
fillOpacity: 0.14
}).addTo(markerLayer);
}

/**********************
* PANEL UI
**********************/
const panel = document.getElementById("panel");
const placeEl = document.getElementById("place");
const metaEl = document.getElementById("meta");
const mappedSection = document.getElementById("mappedSection");
const mappedList = document.getElementById("mappedList");
const aiSection = document.getElementById("aiSection");
const aiLines = document.getElementById("aiLines");
const aiList = document.getElementById("aiList");

const MIN_ZOOM_SHOW = 4;
const DEBOUNCE_MS = 650;

function renderMapped(list){
mappedList.innerHTML = "";
for (const p of list){
const div = document.createElement("div");
div.className = "item mapped";
div.innerHTML = `<span class="n">${escapeHtml(p.name)}</span><span class="t">${escapeHtml(p.tagline)}</span>`;
mappedList.appendChild(div);
}
}

function pickSuggestions(geo){
const cityKey = normKey(geo?.city);
const regionKey = normKey(geo?.region);
const countryKey = normKey(geo?.country);

return (cityKey && suggestedByCity[cityKey]) ? suggestedByCity[cityKey] :
(regionKey && suggestedByRegion[regionKey]) ? suggestedByRegion[regionKey] :
(countryKey && suggestedByCountry[countryKey]) ? suggestedByCountry[countryKey] :
[];
}

function renderAi(geo, hasMapped){
aiLines.innerHTML = "";
aiList.innerHTML = "";

const l1 = document.createElement("div");
l1.className = "aiLine";
l1.textContent = AI_LINE_A;
aiLines.appendChild(l1);

const cats = genericAiCategories.join(", ");
const l2 = document.createElement("div");
l2.className = "aiLine";
l2.textContent = AI_LINE_B(cats);
aiLines.appendChild(l2);

if (map.getZoom() >= 9){
const l3 = document.createElement("div");
l3.className = "aiLine";
l3.textContent = AI_LINE_C;
aiLines.appendChild(l3);
}

if (hasMapped){
const l4 = document.createElement("div");
l4.className = "aiLine";
l4.textContent = AI_LINE_D;
aiLines.appendChild(l4);
}

const suggestions = pickSuggestions(geo);

if (suggestions.length){
for (const s of suggestions){
const div = document.createElement("div");
div.className = "item suggested";
div.innerHTML = `<span class="n">${escapeHtml(s.name)}</span><span class="t">${escapeHtml(s.hint)}</span>`;
div.style.cursor = "pointer";
div.addEventListener("click", () => {
alert(`${AI_CLICK_1}\n\n${AI_CLICK_2}\n\n${AI_CLICK_3}`);
openExplore(s.name);
});
aiList.appendChild(div);
}
} else {
const row = document.createElement("div");
row.className = "btnRow";

const b1 = document.createElement("a");
b1.className = "btn";
b1.href = "#";
b1.textContent = "Explore human action here";
b1.addEventListener("click", (e) => {
e.preventDefault();
alert(`${AI_CLICK_3}`);
const q = (geo?.place && geo.place !== "This area") ? geo.place : "human action";
openExplore(q + " community initiatives");
});

row.appendChild(b1);
aiList.appendChild(row);
}
}

let timer = null;
async function updatePanel(){
const z = map.getZoom();
if (z < MIN_ZOOM_SHOW){
panel.classList.remove("show");
return;
}

const bounds = map.getBounds();
const center = map.getCenter();
const mappedInView = pointsInBounds(bounds);

let geo = { place:"This area", city:null, region:null, country:null };

try{
const r = await reverseGeocode(center.lat, center.lng);
if (r) geo = r;
}catch(e){}

// Expose for debugging if needed
window.__geo = geo;

placeEl.textContent = geo.place;

if (mappedInView.length){
metaEl.textContent = `${mappedInView.length} initiative${mappedInView.length>1 ? "s" : ""} visible here`;
mappedSection.style.display = "block";
renderMapped(mappedInView);
} else {
metaEl.textContent = "0 mapped initiatives visible here";
mappedSection.style.display = "none";
mappedList.innerHTML = "";
}

aiSection.style.display = "block";
renderAi(geo, mappedInView.length > 0);

panel.classList.add("show");
}

function scheduleUpdate(){
clearTimeout(timer);
timer = setTimeout(updatePanel, DEBOUNCE_MS);
}

map.on("moveend", scheduleUpdate);
map.on("zoomend", scheduleUpdate);
scheduleUpdate();
</script>
</body>
</html>
